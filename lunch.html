<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>점심 메뉴 선택기</title>
  <style>
    /* ... (스타일 동일, 생략) ... */
  </style>
</head>
<body>
  <div class="container">
    <!-- ... (상단 레이아웃 동일, 생략) ... -->
  </div>

  <script>
    // --- 기본 데이터
    const TYPES = ["한식","중식","일식","분식","양식","아시안","카페/디저트","기타"];

    const DEFAULT_MENUS = [
      {name:"김치찌개", price:9000, spicy:2, type:"한식", speed:"normal", tags:["국밥", "회사앞"]},
      {name:"된장찌개", price:9000, spicy:0, type:"한식", speed:"normal", tags:["국밥"]},
      {name:"비빔밥", price:9000, spicy:1, type:"한식", speed:"normal", tags:["채식 옵션"]},
      {name:"돼지불고기덮밥", price:9500, spicy:1, type:"한식", speed:"quick", tags:["덮밥"]},
      {name:"칼국수", price:8500, spicy:0, type:"한식", speed:"normal", tags:["면"]},
      {name:"냉면", price:10000, spicy:1, type:"한식", speed:"quick", tags:["여름"]},
      {name:"짜장면", price:8000, spicy:0, type:"중식", speed:"quick", tags:["면", "배달"]},
      {name:"짬뽕", price:9000, spicy:2, type:"중식", speed:"normal", tags:["면"]},
      {name:"마라탕", price:11000, spicy:3, type:"중식", speed:"normal", tags:["마라"]},
      {name:"된장라멘", price:11000, spicy:1, type:"일식", speed:"normal", tags:["라멘"]},
      {name:"돈카츠", price:12000, spicy:0, type:"일식", speed:"normal", tags:["정식"]},
      {name:"규동", price:9500, spicy:0, type:"일식", speed:"quick", tags:["덮밥"]},
      {name:"김밥", price:4000, spicy:0, type:"분식", speed:"quick", tags:["가성비", "포장"]},
      {name:"라볶이", price:7000, spicy:2, type:"분식", speed:"quick", tags:["분식"]},
      {name:"파스타", price:13000, spicy:0, type:"양식", speed:"normal", tags:["면"]},
      {name:"피자 1조각", price:5500, spicy:0, type:"양식", speed:"quick", tags:["슬라이스"]},
      {name:"쌀국수", price:11000, spicy:1, type:"아시안", speed:"normal", tags:["면"]},
      {name:"팟타이", price:11000, spicy:1, type:"아시안", speed:"normal", tags:["볶음면"]},
      {name:"샐러드", price:9500, spicy:0, type:"기타", speed:"quick", tags:["가벼움", "채식"]},
      {name:"아메리카노", price:2500, spicy:0, type:"카페/디저트", speed:"quick", tags:["커피", "후식"]}
    ];

    // --- Storage helpers
    const LS_KEY = "lunch.menus.v1";
    const LS_HIST = "lunch.history.v1";

    const loadMenus = () => {
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : DEFAULT_MENUS;
      } catch { return DEFAULT_MENUS; }
    }
    const saveMenus = (menus) => localStorage.setItem(LS_KEY, JSON.stringify(menus));

    const loadHist = () => {
      try { return JSON.parse(localStorage.getItem(LS_HIST) || "[]"); } catch { return []; }
    }
    const saveHist = (hist) => localStorage.setItem(LS_HIST, JSON.stringify(hist.slice(0, 24)));

    // --- DOM refs
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const typeChips = document.getElementById('typeChips');
    const resultEl = document.getElementById('result');
    const histEl = document.getElementById('history');
    const mapLink = document.getElementById('mapLink');

    const minPrice = document.getElementById('minPrice');
    const maxPrice = document.getElementById('maxPrice');
    const spicy = document.getElementById('spicy');
    const speed = document.getElementById('speed');
    const q = document.getElementById('q');

    const nameNew = document.getElementById('name');
    const priceNew = document.getElementById('price');
    const spicyNew = document.getElementById('spicyNew');
    const typeNew = document.getElementById('typeNew');
    const speedNew = document.getElementById('speedNew');
    const tagsNew = document.getElementById('tagsNew');

    const btnRecommend = document.getElementById('btnRecommend');
    const btnReset = document.getElementById('btnReset');
    const btnClearAll = document.getElementById('btnClearAll');
    const btnAdd = document.getElementById('btnAdd');

    // --- Utils
    const emojiByType = (t) => ({
      '한식':'🍚','중식':'🥡','일식':'🍱','분식':'🍢','양식':'🍝','아시안':'🍜','카페/디저트':'☕','기타':'🥗'
    }[t] || '🍽️');

    // 가격 표시 헬퍼: 숫자면 1,234원, 아니면 '시세'
    function priceText(m) {
      const n = Number(m.price);
      return Number.isFinite(n) ? `${n.toLocaleString()}원` : '시세';
    }

    // --- State
    let MENUS = loadMenus();

    function matchesFilter(m) {
      const min = Number(minPrice.value || 0);
      const max = Number(maxPrice.value || Infinity);
      const p = Number(m.price);
      if (Number.isFinite(p)) {
        if (!(p >= min && p <= max)) return false;
      }
      if (spicy.value !== '' && Number(spicy.value) !== Number(m.spicy)) return false;
      if (speed.value && speed.value !== m.speed) return false;

      const actives = [...typeChips.querySelectorAll('.chip.active')].map(x => x.dataset.type);
      if (actives.length && !actives.includes(m.type)) return false;

      const text = (q.value || '').trim().toLowerCase();
      if (text) {
        const hay = [m.name, m.type, ...(m.tags||[])].join(' ').toLowerCase();
        if (!hay.includes(text)) return false;
      }
      return true;
    }

    function itemTemplate(m) {
      const chip = `<span class="pill">${emojiByType(m.type)} ${m.type}</span>`;
      const spicyText = ['안 매움','약간','보통','매움'][m.spicy] || '-';
      const tags = (m.tags||[]).slice(0,3).map(t=>`<span class="badge">#${t}</span>`).join(' ');
      const del = `<button class="btn btn-del" data-name="${m.name}" title="삭제">🗑</button>`;
      return `
        <div class="item">
          <div>
            <div style="font-weight:700">${m.name} <span class="badge">${priceText(m)}</span> <span class="badge">${spicyText}</span></div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:6px; flex-wrap:wrap">
              ${chip} ${tags}
            </div>
          </div>
          <div style="display:flex; gap:6px; align-items:center">
            <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/maps/search/${encodeURIComponent(m.name)}">지도</a>
            ${del}
          </div>
        </div>`;
    }

    function renderList() {
      const data = MENUS.filter(matchesFilter);
      countEl.textContent = `${data.length}개`;
      listEl.innerHTML = data.map(m => itemTemplate(m)).join('');
      // attach delete buttons
      [...document.querySelectorAll('.btn-del')].forEach(btn => {
        btn.onclick = () => {
          const name = btn.getAttribute('data-name');
          MENUS = MENUS.filter(x => x.name !== name);
          saveMenus(MENUS);
          filterAndRender();
        };
      });
    }

    function filterAndRender() {
      renderList();
    }

    function pickOne() {
      const pool = MENUS.filter(matchesFilter);
      if (!pool.length) return null;
      const mid = (Number(minPrice.value||0) + Number(maxPrice.value||12000)) / 2;
      const weights = pool.map(m => {
        const pnum = Number(m.price);
        const priceScore = Number.isFinite(pnum) ? 1 / (1 + Math.abs((pnum - mid)) / 4000) : 0.9;
        const speedScore = (m.speed === 'quick') ? 1.15 : 1.0;
        return Math.max(0.2, priceScore * speedScore);
      });
      const sum = weights.reduce((a,b)=>a+b,0);
      let r = Math.random() * sum;
      for (let i=0;i<pool.length;i++) { r -= weights[i]; if (r<=0) return pool[i]; }
      return pool[pool.length-1];
    }

    function showResult(m, reason='') {
      if (!m) {
        resultEl.innerHTML = `<div class="name">조건에 맞는 메뉴가 없어요 😢</div><div class="why">필터를 넓혀보세요.</div>`;
        return;
      }
      const spicyText = ['안 매움','약간','보통','매움'][m.spicy] || '-';
      resultEl.innerHTML = `
        <div class="fade">
          <div class="name">${emojiByType(m.type)} ${m.name}</div>
          <div class="why">${m.type} · ${spicyText} · ${priceText(m)}</div>
        </div>`;
      mapLink.href = `https://www.google.com/maps/search/${encodeURIComponent(m.name)}`;
      const hist = loadHist();
      hist.unshift(m.name);
      saveHist(hist);
      renderHistory();
    }

    function renderHistory() {
      const hist = loadHist();
      histEl.innerHTML = hist.slice(0, 12).map(h => `<span class="chip">${h}</span>`).join('');
    }

    // --- Event wiring
    btnRecommend.onclick = () => showResult(pickOne());
    btnReset.onclick = () => {
      minPrice.value = '';
      maxPrice.value = '';
      spicy.value = '';
      speed.value = '';
      q.value = '';
      [...typeChips.children].forEach(c => c.classList.remove('active'));
      filterAndRender();
      resultEl.innerHTML = `<div class="name">무엇을 드실까요? 🙂</div><div class="why">필터를 조정하거나 바로 추천을 눌러보세요.</div>`;
    };

    btnClearAll.onclick = () => {
      if (!confirm('모든 메뉴와 기록을 초기화할까요?')) return;
      localStorage.removeItem(LS_KEY);
      localStorage.removeItem(LS_HIST);
      MENUS = DEFAULT_MENUS.slice();
      renderHistory();
      filterAndRender();
    };

    btnAdd.onclick = () => {
      const nm = (nameNew.value||'').trim();
      const pr = Number(priceNew.value||0);
      if (!nm) return alert('이름을 입력해주세요');
      if (MENUS.some(m => m.name === nm)) return alert('동일한 이름의 메뉴가 이미 있어요');
      const item = {
        name: nm,
        price: Number.isFinite(pr) && pr > 0 ? pr : null,
        spicy: Number(spicyNew.value||0),
        type: typeNew.value,
        speed: speedNew.value,
        tags: (tagsNew.value||'').split(',').map(s=>s.trim()).filter(Boolean)
      };
      MENUS.push(item);
      saveMenus(MENUS);
      nameNew.value = priceNew.value = tagsNew.value = '';
      spicyNew.value = '0';
      filterAndRender();
    };

    [minPrice,maxPrice,spicy,speed,q].forEach(el => el.addEventListener('input', filterAndRender));

    function renderTypeChips() {
      typeChips.innerHTML = '';
      TYPES.forEach(t => {
        const c = document.createElement('button');
        c.className = 'chip';
        c.textContent = t;
        c.setAttribute('data-type', t);
        c.onclick = () => { c.classList.toggle('active'); filterAndRender(); };
        typeChips.appendChild(c);
      });
      typeNew.innerHTML = TYPES.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function init() {
      renderTypeChips();
      renderHistory();
      filterAndRender();
    }
    init();
  </script>
</body>
</html>
