<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì ì‹¬ë©”ë‰´ íˆ¬í‘œê¸° â€” 1ì¸ 3ë©”ë‰´ ì œì•ˆ Â· ìµœë‹¤ì¤‘ë³µ ì„ ì •</title>
  <style>
    :root{--bg:#0b0d12;--card:#111520;--mut:#2a2f3a;--text:#e8ecf3;--sub:#8b95a7;--acc:#4da3ff}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);
         font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,sans-serif}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:22px;margin:0}
    .card{background:var(--card);border:1px solid var(--mut);border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    label{font-weight:600}
    input[type="text"],input[type="date"]{width:100%;background:#0e1118;border:1px solid var(--mut);
      color:var(--text);padding:10px 12px;border-radius:12px}
    .btn{appearance:none;border:1px solid var(--mut);background:#121826;color:var(--text);
      padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;font-weight:600}
    .btn:hover{transform:translateY(-1px);border-color:var(--acc)}
    .btn.primary{background:var(--acc);color:#07121e;border-color:transparent}
    .pill{display:flex;align-items:center;gap:10px;background:#0e131d;border:1px solid var(--mut);
      padding:10px 12px;border-radius:14px}
    .person{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center}
    .name{font-weight:700}
    .menuflex{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .tiny{font-size:12px;color:var(--sub)}
    .result{background:#0e131b;border:1px dashed var(--mut);padding:14px;border-radius:12px}
    .result h3{margin:0 0 8px;font-size:16px}
    .tag{display:inline-block;border:1px solid var(--mut);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--sub)}
    .delete{border:none;background:transparent;color:#ff9a9a;cursor:pointer}
    .footer{margin-top:18px;color:var(--sub);font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid #1d2330;padding:8px;text-align:left}
    th{color:var(--sub);font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ± ì ì‹¬ë©”ë‰´ íˆ¬í‘œê¸° <span class="tiny">â€” 1ì¸ 3ê°œ ì œì•ˆ Â· ìµœë‹¤ì¤‘ë³µ ë‹¹ì„ </span></h1>
      <div class="tiny">Asia/Seoul ê¸°ì¤€ ë‚ ì§œ ê³ ì •</div>
    </header>

    <div class="row">
      <section class="card col" aria-label="ë‚ ì§œ ë° ì‹¤í–‰">
        <div class="row">
          <div class="col">
            <label for="date">ë‚ ì§œ</label>
            <input id="date" type="date" />
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="pickMenu" class="btn primary">ì˜¤ëŠ˜ ë©”ë‰´ ì„ ì •</button>
          <button id="recalc" class="btn">ë‹¤ì‹œ ê³„ì‚°</button>
          <button id="clearAll" class="btn">ëª¨ë“  ì…ë ¥ ë¹„ìš°ê¸°</button>
        </div>
        <div style="margin-top:10px"><span id="todayTag" class="tag"></span></div>
      </section>

      <section class="card col" aria-label="ì‚¬ëŒ ì¶”ê°€">
        <label for="personName">ì ì‹¬ ë¨¹ëŠ” ì‚¬ëŒ ì¶”ê°€ (ê°ì ë©”ë‰´ 3ê°œ ì‘ì„±)</label>
        <div class="row">
          <input id="personName" type="text" placeholder="ì´ë¦„ ì…ë ¥ í›„ ì¶”ê°€" />
          <button id="addPerson" class="btn">ì¶”ê°€</button>
        </div>
        <div class="tiny" style="margin-top:6px">ì‚¬ëŒ/ë©”ë‰´ ì…ë ¥ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.</div>
      </section>
    </div>

    <section class="card" aria-label="ì°¸ê°€ì ëª©ë¡">
      <div class="row" id="peopleList" style="gap:12px"></div>
      <datalist id="menuSuggest"></datalist>
    </section>

    <section class="card" aria-label="ê²°ê³¼">
      <h2 style="margin:0 0 8px">ê²°ê³¼</h2>
      <div id="resultBox" class="result">
        <div class="tiny">ì•„ì§ ê³„ì‚°í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
      </div>
      <div id="freqBox"></div>
    </section>

    <div class="footer">â“˜ ê·œì¹™: ê° ì°¸ê°€ìëŠ” <b>ë©”ë‰´ 3ê°œ</b>ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. ê°€ì¥ ë§ì´ ê²¹ì¹œ ë©”ë‰´ê°€ ê·¸ë‚ ì˜ ì ì‹¬ìœ¼ë¡œ ì„ ì •ë©ë‹ˆë‹¤. ë™ë¥ ì´ë©´ ë‚ ì§œ ê¸°ë°˜ ì‹œë“œë¡œ ë™ë¥  í›„ë³´ ì¤‘ 1ê°œë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì„ íƒí•©ë‹ˆë‹¤.</div>
  </div>

<script>
/* ---------- ì‹œë“œ RNG (ë™ë¥  ê¹¨ê¸°ìš©) ---------- */
function cyrb128(str){
  let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;
  for(let i=0,k;i<str.length;i++){
    k=str.charCodeAt(i);
    h1=h2^Math.imul(h1^k,597399067);
    h2=h3^Math.imul(h2^k,2869860233);
    h3=h4^Math.imul(h3^k,951274213);
    h4=h1^Math.imul(h4^k,2716044179);
  }
  h1=Math.imul(h3^(h1>>>18),597399067);
  h2=Math.imul(h4^(h2>>>22),2869860233);
  h3=Math.imul(h1^(h3>>>17),951274213);
  h4=Math.imul(h2^(h4>>>19),2716044179);
  return [(h1^h2^h3^h4)>>>0,(h2^h1)>>>0,(h3^h1)>>>0,(h4^h1)>>>0];
}
function mulberry32(a){
  return function(){
    let t=a+=0x6D2B79F5;
    t=Math.imul(t^t>>>15,t|1);
    t^=t+Math.imul(t^t>>>7,t|61);
    return ((t^t>>>14)>>>0)/4294967296;
  }
}
function seededChoice(arr, seedStr){
  if(arr.length===1) return arr[0];
  const seed = cyrb128(seedStr)[0];
  const r = mulberry32(seed)();
  return arr[Math.floor(r*arr.length)];
}

/* ---------- ê¸°ë³¸ ë©”ë‰´ ì œì•ˆ (datalist) ---------- */
const DEFAULT_MENUS = [
  "ê¹€ì¹˜ì°Œê°œ","ëœì¥ì°Œê°œ","ë¹„ë¹”ë°¥","ë¶ˆê³ ê¸°","ì œìœ¡ë³¶ìŒ","ëƒ‰ë©´","ì¹¼êµ­ìˆ˜","ê¹€ë°¥","ë–¡ë³¶ì´","ìˆœëŒ€êµ­",
  "ë¶€ëŒ€ì°Œê°œ","ê°ìíƒ•","ì‚¼ê²¹ì‚´ë®ë°¥","ì¹˜í‚¨","í”¼ì","íŒŒìŠ¤íƒ€","í–„ë²„ê±°","ìƒŒë“œìœ„ì¹˜","ìƒëŸ¬ë“œ","ì´ˆë°¥",
  "ëˆì¹´ì¸ ","ë¼ë©˜","ìš°ë™","ì§œì¥ë©´","ì§¬ë½•","íƒ•ìˆ˜ìœ¡","ë§ˆë¼íƒ•","í› ê¶ˆ","ìŒ€êµ­ìˆ˜","íŒŸíƒ€ì´",
  "ì¹´ë ˆ","ë‚˜ì‹œê³ ë­","ë¶„ì§œ","ê·œë™","ê°€ì¸ ë™","í¬ì¼€","ë‘ë¶€ë®ë°¥","ìˆœë‘ë¶€ì°Œê°œ","í•´ì¥êµ­",
  "ì­ˆê¾¸ë¯¸ë³¶ìŒ","ë‚™ì§€ë®ë°¥","ë„ì‹œë½","ì†Œë°”","ë¦¬ì¡°ë˜","ë¶€ë¦¬ë˜","íƒ€ì½”","ì¼€ë°¥","ë³¶ìŒë°¥",
  "ê°ˆë¹„íƒ•","ì„¤ë íƒ•","ì½©ë‚˜ë¬¼êµ­ë°¥","ë¹„ì§€ì°Œê°œ","ë©”ë°€êµ­ìˆ˜"
];

/* ---------- ìƒíƒœ & ì €ì¥ ---------- */
const LS_KEYS = { PEOPLE: 'lunch.people.v2' };
// people: [{name: "í™ê¸¸ë™", picks: ["í”¼ì","íŒŒìŠ¤íƒ€","ìƒëŸ¬ë“œ"]}, ...]

function loadPeople(){
  try{
    const raw = localStorage.getItem(LS_KEYS.PEOPLE);
    const v = raw? JSON.parse(raw) : [];
    // ë§ˆì´ê·¸ë ˆì´ì…˜/ê²€ì¦
    return Array.isArray(v)? v.map(p=>({
      name: String(p.name||'').trim(),
      picks: Array.isArray(p.picks)? (p.picks.concat(['','','']).slice(0,3)) : ['','','']
    })).filter(p=>p.name) : [];
  }catch(e){ return [] }
}
function savePeople(list){
  localStorage.setItem(LS_KEYS.PEOPLE, JSON.stringify(list));
}

/* ---------- DOM ---------- */
const $date = document.getElementById('date');
const $todayTag = document.getElementById('todayTag');
const $addPerson = document.getElementById('addPerson');
const $personName = document.getElementById('personName');
const $peopleList = document.getElementById('peopleList');
const $menuSuggest = document.getElementById('menuSuggest');
const $pickMenu = document.getElementById('pickMenu');
const $recalc = document.getElementById('recalc');
const $clearAll = document.getElementById('clearAll');
const $resultBox = document.getElementById('resultBox');
const $freqBox = document.getElementById('freqBox');

let state = { people: loadPeople() };

/* ---------- ì´ˆê¸°í™” ---------- */
(function init(){
  // datalist ì±„ìš°ê¸°
  DEFAULT_MENUS.forEach(m=>{
    const o=document.createElement('option'); o.value=m; $menuSuggest.appendChild(o);
  });
  // ì„œìš¸ ë‚ ì§œ ê¸°ë³¸ê°’
  const now=new Date(); const tzOffset=now.getTimezoneOffset(); const seoulOffsetMin=-9*60;
  const d=new Date(now.getTime() + (seoulOffsetMin - tzOffset)*60000);
  $date.value = d.toISOString().slice(0,10);
  updateTodayTag();
  renderPeople();
})();

function updateTodayTag(){
  const ds=$date.value; if(!ds){ $todayTag.textContent='ë‚ ì§œ ë¯¸ì§€ì •'; return }
  const weekday=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(ds+'T00:00:00').getDay()];
  $todayTag.textContent = `${ds} (${weekday})`;
}

/* ---------- ì‚¬ëŒ ë Œë” ---------- */
function renderPeople(){
  $peopleList.innerHTML='';
  if(!state.people.length){
    const d=document.createElement('div');
    d.className='tiny'; d.textContent='ì‚¬ëŒì„ ì¶”ê°€í•œ ë’¤ ê°ì ë©”ë‰´ 3ê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
    $peopleList.appendChild(d); return;
  }
  state.people.forEach((p,idx)=>{
    const card=document.createElement('div'); card.className='pill'; card.style.width='100%';
    const inner=document.createElement('div'); inner.className='person'; card.appendChild(inner);
    const nameBox=document.createElement('div'); nameBox.className='name';
    nameBox.innerHTML=`ğŸ‘¤ ${p.name} <button class="delete" title="ì‚­ì œ">ì‚­ì œ</button>`;
    inner.appendChild(nameBox);
    const menus=document.createElement('div'); menus.className='menuflex'; inner.appendChild(menus);
    p.picks.forEach((val,i)=>{
      const inp=document.createElement('input');
      inp.type='text'; inp.setAttribute('list','menuSuggest'); inp.placeholder=`ë©”ë‰´ ${i+1}`;
      inp.value=val||'';
      inp.addEventListener('change',()=>{
        state.people[idx].picks[i]=inp.value.trim();
        savePeople(state.people);
      });
      menus.appendChild(inp);
    });
    nameBox.querySelector('button').addEventListener('click',()=>{
      state.people.splice(idx,1); savePeople(state.people); renderPeople();
    });
    $peopleList.appendChild(card);
  });
}

/* ---------- ì´ë²¤íŠ¸ ---------- */
$addPerson.addEventListener('click', ()=>{
  const v=$personName.value.trim(); if(!v) return;
  if(state.people.some(p=>p.name===v)){ alert('ì´ë¯¸ ì¶”ê°€ëœ ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
  state.people.push({name:v, picks:['','','']});
  savePeople(state.people); $personName.value=''; $personName.focus(); renderPeople();
});
$personName.addEventListener('keydown', e=>{ if(e.key==='Enter') $addPerson.click(); });
$date.addEventListener('change', ()=> updateTodayTag());
$clearAll.addEventListener('click', ()=>{
  if(confirm('ëª¨ë“  ì‚¬ëŒì˜ ë©”ë‰´ ì…ë ¥ì„ ë¹„ìš¸ê¹Œìš”?')){
    state.people = state.people.map(p=>({name:p.name, picks:['','','']}));
    savePeople(state.people); renderPeople();
  }
});

/* ---------- ê³„ì‚° ë¡œì§: ìµœë‹¤ì¤‘ë³µ ì„ ì • ---------- */
function normalizeMenu(s){
  return s.trim().replace(/\s+/g,' ').toLowerCase();
}
function computeWinner(dateStr){
  const entries=[]; // [{raw:"í”¼ì", norm:"í”¼ì", by:"í™ê¸¸ë™"}...]
  state.people.forEach(p=>{
    p.picks.forEach(x=>{
      const raw=(x||'').trim();
      if(raw) entries.push({raw, norm: normalizeMenu(raw), by:p.name});
    });
  });

  // ëª¨ë“  ì°¸ê°€ìê°€ 3ê°œì”© ì±„ì› ëŠ”ì§€ ì²´í¬ (í•„ìˆ˜ ì•„ë‹˜ì´ì§€ë§Œ ê¸°ë³¸ ì •ì±…)
  const incomplete = state.people.filter(p=> p.picks.filter(x=> (x||'').trim()).length<3);
  if(incomplete.length){
    throw new Error(`ì•„ë˜ ì°¸ì—¬ìê°€ 3ê°œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: ${incomplete.map(p=>p.name).join(', ')}`);
  }
  if(entries.length===0) throw new Error('ì…ë ¥ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.');

  const freq=new Map(); // norm -> {count, rawSamples:Set}
  entries.forEach(e=>{
    if(!freq.has(e.norm)) freq.set(e.norm,{count:0, raw:new Set()});
    const f=freq.get(e.norm); f.count++; f.raw.add(e.raw);
  });

  // ìµœëŒ€ ë“í‘œ ì°¾ê¸°
  let max=0; let tops=[];
  for(const [norm,info] of freq.entries()){
    if(info.count>max){ max=info.count; tops=[{norm,info}] }
    else if(info.count===max){ tops.push({norm,info}) }
  }
  // í‘œì‹œìš© ì›ë¬¸: ê°€ì¥ ë§ì´ ë“±ì¥í•œ í‘œê¸° í•˜ë‚˜
  const candidates = tops.map(x=>{
    const display=[...x.info.raw][0]; // ì²« í‘œê¸°
    return {norm:x.norm, display, count:x.info.count};
  });

  const winner = seededChoice(candidates, `${dateStr}|lunch-majority|v1`);
  // ì •ë ¬ëœ ë¹ˆë„ í…Œì´ë¸” ìƒì„±
  const table = [...freq.entries()].map(([norm,info])=>{
    return {display:[...info.raw][0], count:info.count};
  }).sort((a,b)=> b.count-a.count || a.display.localeCompare(b.display,'ko'));

  return { winner, table, totalVotes: entries.length, voters: state.people.length };
}

/* ---------- UI ë°”ì¸ë”© ---------- */
function renderResult(res){
  const {winner, table, totalVotes, voters} = res;
  $resultBox.innerHTML = `
    <h3>ì˜¤ëŠ˜ì˜ ì ì‹¬ë©”ë‰´ ğŸ†</h3>
    <div style="font-size:22px;font-weight:900;margin-bottom:6px">ğŸ½ï¸ ${winner.display}</div>
    <div class="tiny">ë“í‘œìˆ˜: ${winner.count} / ì´ íˆ¬í‘œ ${totalVotes} (ì°¸ê°€ì ${voters}ëª… Â· 1ì¸ 3í‘œ)</div>
  `;
  // ë¹ˆë„í‘œ
  const rows = table.map(r=>`<tr><td>${r.display}</td><td>${r.count}</td></tr>`).join('');
  $freqBox.innerHTML = `
    <h3 style="margin:14px 0 6px">ë“í‘œ í˜„í™©</h3>
    <table>
      <thead><tr><th>ë©”ë‰´</th><th>í‘œ ìˆ˜</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function runCompute(){
  const ds=$date.value;
  if(!ds){ alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  try{
    const res=computeWinner(ds);
    renderResult(res);
  }catch(err){
    $resultBox.innerHTML = `<span class="tiny" style="color:#ffb0b0">ì˜¤ë¥˜: ${err.message}</span>`;
    $freqBox.innerHTML='';
  }
}

$pickMenu.addEventListener('click', runCompute);
$recalc.addEventListener('click', runCompute);

</script>
</body>
</html>
