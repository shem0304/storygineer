<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[ê´€ë¦¬ììš©] ì ì‹¬ë©”ë‰´ ì§‘ê³„ â€” ì œì¶œ í† í° ì·¨í•© Â· ìµœë‹¤ì¤‘ë³µ ì„ ì •</title>
<style>
  :root{--bg:#0b0d12;--card:#111520;--mut:#2a2f3a;--text:#e8ecf3;--sub:#8b95a7;--acc:#4da3ff}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);
       font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,sans-serif}
  .wrap{max-width:1000px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--mut);border-radius:16px;padding:14px;margin-top:12px}
  label{font-weight:700}
  input[type="date"],input[type="text"],textarea{width:100%;background:#0e1118;border:1px solid var(--mut);
        color:var(--text);padding:10px 12px;border-radius:12px}
  textarea{min-height:120px}
  .btn{appearance:none;border:1px solid var(--mut);background:#121826;color:var(--text);
       padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;font-weight:700}
  .btn:hover{transform:translateY(-1px);border-color:var(--acc)}
  .btn.primary{background:var(--acc);color:#07121e;border-color:transparent}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  .tag{display:inline-block;border:1px solid var(--mut);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--sub)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid #1d2330;padding:8px;text-align:left;vertical-align:top}
  th{color:var(--sub)}
  .tiny{font-size:12px;color:var(--sub)}
  .danger{color:#ff9a9a}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ± [ê´€ë¦¬ììš©] ì ì‹¬ë©”ë‰´ ì§‘ê³„</h1>
  <div class="tiny">íë¦„: ì°¸ê°€ìê°€ <b>user í˜ì´ì§€</b>ì—ì„œ í† í°ì„ ìƒì„± â†’ ì´ í™”ë©´ì— ë¶™ì—¬ë„£ì–´ ì·¨í•© â†’ ìµœë‹¤ì¤‘ë³µ ë©”ë‰´ ì‚°ì¶œ</div>

  <section class="card">
    <div class="row">
      <div class="col">
        <label for="date">ëŒ€ìƒ ë‚ ì§œ</label>
        <input id="date" type="date">
        <div class="tiny" id="todayTag"></div>
      </div>
      <div class="col" style="display:flex;align-items:flex-end;gap:8px">
        <button id="calc" class="btn primary">ìµœë‹¤ì¤‘ë³µ ê³„ì‚°</button>
        <button id="exportJson" class="btn">JSON ë‚´ë³´ë‚´ê¸°</button>
        <button id="clearAll" class="btn">ëª¨ë‘ ë¹„ìš°ê¸°</button>
      </div>
    </div>
  </section>

  <section class="card">
    <label for="tokens">ì œì¶œ í† í° ë¶™ì—¬ë„£ê¸° (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</label>
    <textarea id="tokens" placeholder="ê° ì¤„ì— 1ê°œ í† í° ë˜ëŠ” JSON. Base64 ë˜ëŠ” ìˆœìˆ˜ JSON ëª¨ë‘ í—ˆìš©."></textarea>
    <div class="row" style="margin-top:8px">
      <button id="ingest" class="btn">í† í° ì¶”ê°€</button>
      <input id="file" type="file" accept=".txt,.json" style="display:none">
      <button id="loadFile" class="btn">íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="copyInvite" class="btn">ì‚¬ìš©ììš© ì•ˆë‚´ë¬¸ ë³µì‚¬</button>
    </div>
    <div class="tiny" style="margin-top:6px">
      í˜•ì‹: {"version":"v1","date":"YYYY-MM-DD","name":"í™ê¸¸ë™","picks":["í”¼ì","íŒŒìŠ¤íƒ€","ìƒëŸ¬ë“œ"]} ë˜ëŠ” ì´ë¥¼ Base64 ì¸ì½”ë”©í•œ ë¬¸ìì—´
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">ì œì¶œ ëª©ë¡</h3>
    <div class="tiny">ì¤‘ë³µ ì´ë¦„ í—ˆìš©. ê°™ì€ ì‚¬ëŒì´ ì—¬ëŸ¬ ë²ˆ ì œì¶œí–ˆë‹¤ë©´ ìµœì‹  ì œì¶œì„ ë‚¨ê¸°ë ¤ë©´ ê¸°ì¡´ í–‰ì„ ì‚­ì œí•˜ì„¸ìš”.</div>
    <table id="tbl">
      <thead>
        <tr><th style="width:140px">ì´ë¦„</th><th>ë©”ë‰´1</th><th>ë©”ë‰´2</th><th>ë©”ë‰´3</th><th style="width:90px">ë‚ ì§œ</th><th style="width:80px">ì‘ì—…</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">ê²°ê³¼</h3>
    <div id="resultBox" class="tiny">ì•„ì§ ê³„ì‚°í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
    <div id="freqBox"></div>
  </section>
</div>

<script>
/* ===== ê³µìš© ìœ í‹¸ (UTF-8 Base64, ì‹œë“œ ì„ íƒ, ì •ê·œí™”) ===== */
function b64encodeUtf8(s){return btoa(unescape(encodeURIComponent(s)));}
function b64decodeUtf8(s){return decodeURIComponent(escape(atob(s)));}

function cyrb128(str){
  let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;
  for(let i=0,k;i<str.length;i++){
    k=str.charCodeAt(i);
    h1=h2^Math.imul(h1^k,597399067);
    h2=h3^Math.imul(h2^k,2869860233);
    h3=h4^Math.imul(h3^k,951274213);
    h4=h1^Math.imul(h4^k,2716044179);
  }
  h1=Math.imul(h3^(h1>>>18),597399067);
  h2=Math.imul(h4^(h2>>>22),2869860233);
  h3=Math.imul(h1^(h3>>>17),951274213);
  h4=Math.imul(h2^(h4>>>19),2716044179);
  return [(h1^h2^h3^h4)>>>0,(h2^h1)>>>0,(h3^h1)>>>0,(h4^h1)>>>0];
}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function seededChoice(arr, seedStr){if(arr.length===1) return arr[0]; const seed=cyrb128(seedStr)[0]; const r=mulberry32(seed)(); return arr[Math.floor(r*arr.length)];}
function normalizeMenu(s){return s.trim().replace(/\s+/g,' ').toLowerCase();}

/* ===== ìƒíƒœ ===== */
let submissions = []; // {name, picks:[a,b,c], date}

/* ===== ë‚ ì§œ ê¸°ë³¸ê°’(Seoul) ===== */
const $date = document.getElementById('date');
const $todayTag = document.getElementById('todayTag');
(function initDate(){
  const now=new Date(); const tz=now.getTimezoneOffset(); const seoul=-9*60;
  const d=new Date(now.getTime() + (seoul - tz)*60000);
  $date.value = d.toISOString().slice(0,10);
  updateTodayTag();
})();
function updateTodayTag(){
  const ds=$date.value; if(!ds){ $todayTag.textContent='ë‚ ì§œ ë¯¸ì§€ì •'; return }
  const wd=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(ds+'T00:00:00').getDay()];
  $todayTag.textContent = `ì„ ì • ê¸°ì¤€ ë‚ ì§œ: ${ds} (${wd})`;
}

/* ===== DOM ===== */
const $tokens = document.getElementById('tokens');
const $ingest = document.getElementById('ingest');
const $tblBody = document.querySelector('#tbl tbody');
const $calc = document.getElementById('calc');
const $resultBox = document.getElementById('resultBox');
const $freqBox = document.getElementById('freqBox');
const $clearAll = document.getElementById('clearAll');
const $exportJson = document.getElementById('exportJson');
const $loadFile = document.getElementById('loadFile');
const $file = document.getElementById('file');
const $copyInvite = document.getElementById('copyInvite');

/* ===== ë Œë” ===== */
function renderTable(){
  $tblBody.innerHTML='';
  submissions.forEach((s,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${s.name}</td>
      <td>${s.picks[0]||''}</td>
      <td>${s.picks[1]||''}</td>
      <td>${s.picks[2]||''}</td>
      <td>${s.date}</td>
      <td><button data-idx="${idx}" class="btn" style="padding:6px 10px">ì‚­ì œ</button></td>
    `;
    tr.querySelector('button').addEventListener('click', e=>{
      const i=parseInt(e.target.getAttribute('data-idx'),10);
      submissions.splice(i,1); renderTable();
    });
    $tblBody.appendChild(tr);
  });
}

/* ===== í† í° íŒŒì„œ ===== */
function parseTokenLine(line){
  line=line.trim();
  if(!line) return null;
  try{
    // JSONë¡œ ì§ì ‘ ë“¤ì–´ì˜¨ ê²½ìš°
    if(line.startsWith('{')) return JSON.parse(line);
    // Base64 -> JSON
    const json = b64decodeUtf8(line);
    return JSON.parse(json);
  }catch(e){
    throw new Error('í† í°/JSON í•´ì„ ì‹¤íŒ¨: ' + line.slice(0,50));
  }
}
function validateSubmission(obj){
  if(!obj || obj.version!=='v1') throw new Error('version=v1 í•„ìš”');
  if(!obj.name || !obj.date || !Array.isArray(obj.picks) || obj.picks.length!==3)
    throw new Error('í•„ë“œ(name,date,picks[3]) ëˆ„ë½');
  // ê°„ë‹¨ ì •ì œ
  obj.name = String(obj.name).trim();
  obj.picks = obj.picks.map(x=> String(x||'').trim());
  return obj;
}

/* ===== ê³„ì‚° ===== */
function computeWinner(targetDate){
  const filtered = submissions.filter(s => s.date === targetDate);
  if(!filtered.length) throw new Error('í•´ë‹¹ ë‚ ì§œ ì œì¶œì´ ì—†ìŠµë‹ˆë‹¤.');
  const entries=[];
  filtered.forEach(s => s.picks.forEach(x=>{
    if(x) entries.push({raw:x, norm:normalizeMenu(x)});
  }));
  if(!entries.length) throw new Error('ì œì¶œ ë‚´ì—­ì— ë©”ë‰´ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
  const freq = new Map(); // norm -> {count, raw:Set}
  entries.forEach(e=>{
    if(!freq.has(e.norm)) freq.set(e.norm,{count:0, raw:new Set()});
    const f=freq.get(e.norm); f.count++; f.raw.add(e.raw);
  });
  let max=0, tops=[];
  for(const [norm,info] of freq.entries()){
    if(info.count>max){ max=info.count; tops=[{norm,info}] }
    else if(info.count===max){ tops.push({norm,info}) }
  }
  const candidates = tops.map(x=>({display:[...x.info.raw][0], count:x.info.count}));
  const winner = seededChoice(candidates, `${targetDate}|lunch-majority|v1`);
  const table = [...freq.entries()].map(([norm,info])=>({display:[...info.raw][0], count:info.count}))
                .sort((a,b)=> b.count-a.count || a.display.localeCompare(b.display,'ko'));
  return {winner, table, voters: filtered.length, totalVotes: filtered.length*3};
}

/* ===== ì´ë²¤íŠ¸ ===== */
$ingest.addEventListener('click', ()=>{
  const lines=$tokens.value.split(/\r?\n/).filter(Boolean);
  let ok=0, fail=[];
  lines.forEach(line=>{
    try{
      const obj=validateSubmission(parseTokenLine(line));
      submissions.push({name: obj.name, picks: obj.picks, date: obj.date});
      ok++;
    }catch(e){ fail.push(e.message); }
  });
  $tokens.value='';
  renderTable();
  if(fail.length) alert(`ì¶”ê°€ë¨: ${ok}ê±´, ì‹¤íŒ¨: ${fail.length}ê±´\nâ€” ${fail.slice(0,5).join('\n')}${fail.length>5?'\nâ€¦':''}`);
});

$calc.addEventListener('click', ()=>{
  const ds=$date.value;
  if(!ds){ alert('ë‚ ì§œë¥¼ ì§€ì •í•˜ì„¸ìš”.'); return; }
  try{
    const res=computeWinner(ds);
    $resultBox.innerHTML = `
      <div style="font-size:20px;font-weight:900;margin-bottom:6px">ğŸ† ì˜¤ëŠ˜ì˜ ë©”ë‰´: ğŸ½ï¸ ${res.winner.display}</div>
      <div class="tiny">ë“í‘œ ${res.winner.count} / ì´ ${res.totalVotes} (ì°¸ê°€ì ${res.voters}ëª… Â· 1ì¸ 3í‘œ)</div>
    `;
    const rows = res.table.map(r=>`<tr><td>${r.display}</td><td>${r.count}</td></tr>`).join('');
    $freqBox.innerHTML = `<table><thead><tr><th>ë©”ë‰´</th><th>í‘œ ìˆ˜</th></tr></thead><tbody>${rows}</tbody></table>`;
    // ìš”ì•½ ë³µì‚¬ ë²„íŠ¼ ë™ì‘ ëŒ€ì²´: ê²°ê³¼ í…ìŠ¤íŠ¸ë¥¼ í´ë¦­í•˜ë©´ ë³µì‚¬
    $resultBox.style.cursor='copy';
    $resultBox.onclick=async ()=>{
      const text = `(${ds}) ì˜¤ëŠ˜ì˜ ì ì‹¬: ${res.winner.display} â€” ìµœë‹¤ì¤‘ë³µ`;
      try{ await navigator.clipboard.writeText(text); alert('ê²°ê³¼ ìš”ì•½ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'); }catch(_){}
    };
  }catch(e){
    $resultBox.innerHTML = `<span class="danger">ì˜¤ë¥˜: ${e.message}</span>`;
    $freqBox.innerHTML = '';
  }
});

$clearAll.addEventListener('click', ()=>{
  if(confirm('ëª¨ë“  ì œì¶œì„ ë¹„ìš¸ê¹Œìš”?')){ submissions=[]; renderTable(); $resultBox.textContent='ì´ˆê¸°í™”ë¨'; $freqBox.innerHTML=''; }
});

$exportJson.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(submissions,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='lunch_submissions.json'; a.click();
  URL.revokeObjectURL(url);
});

$loadFile.addEventListener('click', ()=> $file.click());
$file.addEventListener('change', ()=>{
  const f=$file.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const txt=r.result;
      // JSON ë°°ì—´ / ì¤„ë‹¨ìœ„ í† í° ë‘˜ ë‹¤ í—ˆìš©
      if(txt.trim().startsWith('[')){
        const arr=JSON.parse(txt);
        arr.forEach(o=>{
          const v=validateSubmission(o);
          submissions.push({name:v.name,picks:v.picks,date:v.date});
        });
      }else{
        txt.split(/\r?\n/).forEach(line=>{
          if(!line.trim()) return;
          const o=validateSubmission(parseTokenLine(line));
          submissions.push({name:o.name,picks:o.picks,date:o.date});
        });
      }
      renderTable();
    }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message); }
  };
  r.readAsText(f,'utf-8');
});

$copyInvite.addEventListener('click', async ()=>{
  const msg =
`[ì‚¬ìš©ììš© ì•ˆë‚´]
1) 'lunch_user.html'ì„ ì—´ì–´ ì´ë¦„ê³¼ ì˜¤ëŠ˜ ë‚ ì§œ, ë©”ë‰´ 3ê°œë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
2) "ì œì¶œ í† í° ë§Œë“¤ê¸°"ë¥¼ ëˆŒëŸ¬ ìƒì„±ëœ í† í°ì„ ë³µì‚¬í•©ë‹ˆë‹¤.
3) ì´ ì±„ë„/ì–‘ì‹ì— í† í°ì„ ë¶™ì—¬ ì œì¶œí•˜ì„¸ìš”. (í•œ ì¤„ 1ê°œ)`;
  try{ await navigator.clipboard.writeText(msg); alert('ì•ˆë‚´ë¬¸ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.'); }catch(_){}
});

/* ì´ˆê¸° ë Œë” */
renderTable();
</script>
</body>
</html>
