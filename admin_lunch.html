<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[관리자용] 점심메뉴 집계 — 파일 불러오기 · 최다중복 선정</title>
<style>
  :root{--bg:#0b0d12;--card:#111520;--mut:#2a2f3a;--text:#e8ecf3;--sub:#8b95a7;--acc:#4da3ff}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);
       font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,sans-serif}
  .wrap{max-width:1000px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--mut);border-radius:16px;padding:14px;margin-top:12px}
  label{font-weight:700}
  input[type="date"],input[type="text"]{width:100%;background:#0e1118;border:1px solid var(--mut);
        color:var(--text);padding:10px 12px;border-radius:12px}
  .btn{appearance:none;border:1px solid var(--mut);background:#121826;color:var(--text);
       padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;font-weight:700}
  .btn:hover{transform:translateY(-1px);border-color:var(--acc)}
  .btn.primary{background:var(--acc);color:#07121e;border-color:transparent}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  .tiny{font-size:12px;color:var(--sub)}
  .tag{display:inline-block;border:1px solid var(--mut);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--sub)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid #1d2330;padding:8px;text-align:left;vertical-align:top}
  th{color:var(--sub)}
  #drop{border:2px dashed #2a2f3a;border-radius:12px;padding:14px;text-align:center}
  #drop.drag{border-color:#4da3ff;background:#0e1522}
  .danger{color:#ff9a9a}
</style>
</head>
<body>
<div class="wrap">
  <h1>🍱 [관리자용] 점심메뉴 집계 (파일 불러오기)</h1>
  <div class="tiny">흐름: 참가자가 <b>user 파일</b>로 본인 제출을 저장 → 이 화면에서 <b>여러 .txt/.json 파일</b> 불러오기 → 최다중복 산출</div>

  <section class="card">
    <div class="row">
      <div class="col">
        <label for="date">대상 날짜</label>
        <input id="date" type="date">
        <div class="tiny" id="todayTag"></div>
      </div>
      <div class="col" style="display:flex;align-items:flex-end;gap:8px">
        <button id="calc" class="btn primary">최다중복 계산</button>
        <button id="exportJson" class="btn">현재 목록 JSON 내보내기</button>
        <button id="clearAll" class="btn">목록 비우기</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="col">
        <label>제출 파일 불러오기 (.txt / .json, 다중 선택)</label>
        <input id="files" type="file" accept=".txt,.json,application/json,text/plain" multiple>
      </div>
    </div>
    <div id="drop" style="margin-top:10px">여기에 파일을 끌어다 놓아도 됩니다 (여러 개 가능)</div>
    <div class="tiny" style="margin-top:6px">파일 내용 형식 (단일 JSON): {"version":"v1","date":"YYYY-MM-DD","name":"홍길동","picks":["피자","파스타","샐러드"]}</div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">제출 목록</h3>
    <div class="tiny">같은 사람이 여러 번 제출하면 최신 파일로 교체하려면 기존 행을 삭제하세요.</div>
    <table id="tbl">
      <thead>
        <tr><th style="width:140px">이름</th><th>메뉴1</th><th>메뉴2</th><th>메뉴3</th><th style="width:110px">날짜</th><th style="width:80px">작업</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">결과</h3>
    <div id="resultBox" class="tiny">아직 계산하지 않았습니다.</div>
    <div id="freqBox"></div>
  </section>
</div>

<script>
/* ===== 시드/정규화 유틸 ===== */
function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;
  for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);
    h1=h2^Math.imul(h1^k,597399067);h2=h3^Math.imul(h2^k,2869860233);
    h3=h4^Math.imul(h3^k,951274213);h4=h1^Math.imul(h4^k,2716044179);}
  h1=Math.imul(h3^(h1>>>18),597399067);h2=Math.imul(h4^(h2>>>22),2869860233);
  h3=Math.imul(h1^(h3>>>17),951274213);h4=Math.imul(h2^(h4>>>19),2716044179);
  return [(h1^h2^h3^h4)>>>0,(h2^h1)>>>0,(h3^h1)>>>0,(h4^h1)>>>0];}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function seededChoice(arr,seedStr){if(arr.length===1) return arr[0]; const seed=cyrb128(seedStr)[0]; const r=mulberry32(seed)(); return arr[Math.floor(r*arr.length)];}
function normalizeMenu(s){return s.trim().replace(/\s+/g,' ').toLowerCase();}

/* ===== 상태 ===== */
let submissions = []; // {name, picks:[a,b,c], date}

/* ===== 날짜 기본값(Seoul) ===== */
const $date=document.getElementById('date');
const $todayTag=document.getElementById('todayTag');
(function initDate(){
  const now=new Date(); const tz=now.getTimezoneOffset(); const seoul=-9*60;
  const d=new Date(now.getTime() + (seoul - tz)*60000);
  $date.value = d.toISOString().slice(0,10); updateTodayTag();
})();
function updateTodayTag(){
  const ds=$date.value; if(!ds){ $todayTag.textContent='날짜 미지정'; return }
  const wd=['일','월','화','수','목','금','토'][new Date(ds+'T00:00:00').getDay()];
  $todayTag.textContent = `선정 기준 날짜: ${ds} (${wd})`;
}

/* ===== DOM ===== */
const $files=document.getElementById('files');
const $drop=document.getElementById('drop');
const $tblBody=document.querySelector('#tbl tbody');
const $calc=document.getElementById('calc');
const $resultBox=document.getElementById('resultBox');
const $freqBox=document.getElementById('freqBox');
const $clearAll=document.getElementById('clearAll');
const $exportJson=document.getElementById('exportJson');

/* ===== 렌더 ===== */
function renderTable(){
  $tblBody.innerHTML='';
  submissions.forEach((s,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.picks[0]||''}</td>
      <td>${s.picks[1]||''}</td>
      <td>${s.picks[2]||''}</td>
      <td>${s.date}</td>
      <td><button data-idx="${idx}" class="btn" style="padding:6px 10px">삭제</button></td>`;
    tr.querySelector('button').addEventListener('click',e=>{
      const i=parseInt(e.target.getAttribute('data-idx'),10);
      submissions.splice(i,1); renderTable();
    });
    $tblBody.appendChild(tr);
  });
}

/* ===== 파일 로딩 ===== */
async function readFileAsText(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=()=>rej(r.error);
    r.readAsText(file,'utf-8');
  });
}
function validateSubmission(obj){
  if(!obj || obj.version!=='v1') throw new Error('version=v1 필요');
  if(!obj.name || !obj.date || !Array.isArray(obj.picks) || obj.picks.length!==3)
    throw new Error('필드(name,date,picks[3]) 누락');
  return {name:String(obj.name).trim(), date:String(obj.date).trim(),
          picks:obj.picks.map(x=>String(x||'').trim())};
}
async function handleFiles(fileList){
  let ok=0, fail=[];
  for(const f of fileList){
    try{
      const txt=await readFileAsText(f);
      const obj=JSON.parse(txt);
      const v=validateSubmission(obj);
      submissions.push(v); ok++;
    }catch(e){ fail.push(`${f.name}: ${e.message}`); }
  }
  renderTable();
  if(fail.length) alert(`불러옴: ${ok}건, 실패: ${fail.length}건\n— ${fail.slice(0,5).join('\n')}${fail.length>5?'\n…':''}`);
}
$files.addEventListener('change', e=>{
  if(e.target.files && e.target.files.length) handleFiles(e.target.files);
});
['dragenter','dragover'].forEach(evt=>{
  $drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.add('drag'); });
});
['dragleave','drop'].forEach(evt=>{
  $drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.remove('drag'); });
});
$drop.addEventListener('drop', e=>{
  const files=e.dataTransfer.files; if(files && files.length) handleFiles(files);
});

/* ===== 계산 ===== */
function computeWinner(targetDate){
  const filtered=submissions.filter(s=>s.date===targetDate);
  if(!filtered.length) throw new Error('해당 날짜 제출이 없습니다.');
  const entries=[];
  filtered.forEach(s=> s.picks.forEach(x=>{ if(x) entries.push({raw:x, norm:normalizeMenu(x)}); }));
  if(!entries.length) throw new Error('제출 내역에 메뉴가 비어 있습니다.');

  const freq=new Map(); // norm -> {count, raw:Set}
  entries.forEach(e=>{
    if(!freq.has(e.norm)) freq.set(e.norm,{count:0,raw:new Set()});
    const f=freq.get(e.norm); f.count++; f.raw.add(e.raw);
  });
  let max=0, tops=[];
  for(const [norm,info] of freq.entries()){
    if(info.count>max){ max=info.count; tops=[{norm,info}] }
    else if(info.count===max){ tops.push({norm,info}) }
  }
  const candidates=tops.map(x=>({display:[...x.info.raw][0], count:x.info.count}));
  const winner=seededChoice(candidates, `${targetDate}|lunch-majority|v1`);
  const table=[...freq.entries()].map(([norm,info])=>({display:[...info.raw][0], count:info.count}))
               .sort((a,b)=> b.count-a.count || a.display.localeCompare(b.display,'ko'));
  return {winner, table, voters: filtered.length, totalVotes: filtered.length*3};
}

/* ===== 이벤트 ===== */
$calc.addEventListener('click', ()=>{
  const ds=$date.value; if(!ds){ alert('날짜를 지정하세요.'); return; }
  try{
    const res=computeWinner(ds);
    $resultBox.innerHTML = `
      <div style="font-size:20px;font-weight:900;margin-bottom:6px">🏆 오늘의 메뉴: 🍽️ ${res.winner.display}</div>
      <div class="tiny">득표 ${res.winner.count} / 총 ${res.totalVotes} (참가자 ${res.voters}명 · 1인 3표)</div>`;
    const rows=res.table.map(r=>`<tr><td>${r.display}</td><td>${r.count}</td></tr>`).join('');
    $freqBox.innerHTML=`<table><thead><tr><th>메뉴</th><th>표 수</th></tr></thead><tbody>${rows}</tbody></table>`;
    $resultBox.style.cursor='copy';
    $resultBox.onclick=async ()=>{
      const text=`(${ds}) 오늘의 점심: ${res.winner.display} — 최다중복`;
      try{ await navigator.clipboard.writeText(text); alert('결과 요약을 복사했습니다.'); }catch(_){}
    };
  }catch(e){
    $resultBox.innerHTML = `<span class="danger">오류: ${e.message}</span>`;
    $freqBox.innerHTML='';
  }
});
$clearAll.addEventListener('click', ()=>{
  if(confirm('목록을 모두 비울까요?')){ submissions=[]; renderTable(); $resultBox.textContent='초기화됨'; $freqBox.innerHTML=''; }
});
$exportJson.addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(submissions,null,2)], {type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='lunch_submissions.json'; a.click();
  URL.revokeObjectURL(url);
});

/* 초기 렌더 */
renderTable();
</script>
</body>
</html>
