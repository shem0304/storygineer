<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[ì‚¬ìš©ììš©] ì ì‹¬ë©”ë‰´ ì œì¶œ â€” GitHub ìë™ ì—…ë¡œë“œ (í† í° ì‚¬ìš©)</title>
<style>
  :root{--bg:#0b0d12;--card:#111520;--mut:#2a2f3a;--text:#e8ecf3;--sub:#8b95a7;--acc:#4da3ff}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);
       font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,sans-serif}
  .wrap{max-width:760px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--mut);border-radius:16px;padding:14px;margin-top:12px}
  label{font-weight:700}
  input[type="date"],input[type="text"],input[type="password"],textarea{width:100%;background:#0e1118;border:1px solid var(--mut);
        color:var(--text);padding:10px 12px;border-radius:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 180px}
  .btn{appearance:none;border:1px solid var(--mut);background:#121826;color:var(--text);
       padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;font-weight:700}
  .btn:hover{transform:translateY(-1px);border-color:var(--acc)}
  .btn.primary{background:var(--acc);color:#07121e;border-color:transparent}
  .tiny{font-size:12px;color:var(--sub)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .ok{color:#8fe18f}.warn{color:#ffd27d}.err{color:#ff9a9a}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ± ì ì‹¬ë©”ë‰´ ì œì¶œ â€” GitHub ìë™ ì—…ë¡œë“œ</h1>
  <div class="tiny">ì´ë¦„Â·ë‚ ì§œÂ·ë©”ë‰´ 3ê°œ ì…ë ¥ â†’ â€œGitHubë¡œ ì—…ë¡œë“œâ€ë¥¼ ëˆ„ë¥´ë©´ <b>shem0304/storygineer</b> ì €ì¥ì†Œë¡œ ë°”ë¡œ ì—…ë¡œë“œë©ë‹ˆë‹¤.</div>

  <section class="card">
    <div class="row">
      <div class="col"><label for="name">ì´ë¦„</label><input id="name" type="text" placeholder="ë³¸ì¸ ì´ë¦„"></div>
      <div class="col"><label for="date">ë‚ ì§œ</label><input id="date" type="date"><div id="todayTag" class="tiny"></div></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label for="m1">ë©”ë‰´ 1</label><input id="m1" type="text" list="suggest" placeholder="ì˜ˆ: ê¹€ì¹˜ì°Œê°œ"></div>
      <div class="col"><label for="m2">ë©”ë‰´ 2</label><input id="m2" type="text" list="suggest" placeholder="ì˜ˆ: íŒŒìŠ¤íƒ€"></div>
      <div class="col"><label for="m3">ë©”ë‰´ 3</label><input id="m3" type="text" list="suggest" placeholder="ì˜ˆ: ì´ˆë°¥"></div>
    </div>
    <datalist id="suggest"></datalist>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px">GitHub ì—…ë¡œë“œ ì„¤ì •</h3>
    <div class="row">
      <div class="col"><label for="owner">Owner</label><input id="owner" type="text" value="shem0304"></div>
      <div class="col"><label for="repo">Repo</label><input id="repo" type="text" value="storygineer"></div>
      <div class="col"><label for="branch">Branch</label><input id="branch" type="text" value="gh-pages" placeholder="ì˜ˆ: gh-pages ë˜ëŠ” main"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label for="subdir">ì—…ë¡œë“œ í•˜ìœ„ ê²½ë¡œ(ì„ íƒ)</label><input id="subdir" type="text" value="submissions" placeholder="ì˜ˆ: submissions / docs/submissions"></div>
      <div class="col">
        <label for="token">GitHub í† í° (Contents: Read & Write)</label>
        <input id="token" type="password" placeholder="Fine-grained PAT ì…ë ¥ (ì €ì¥ ì•ˆ í•¨)">
        <div class="tiny" style="margin-top:6px;display:flex;gap:10px;align-items:center">
          <label style="display:flex;align-items:center;gap:6px"><input id="rememberToken" type="checkbox">ì´ í† í°ì„ <b>ì´ ë¸Œë¼ìš°ì € íƒ­</b>ì—ë§Œ ê¸°ì–µ</label>
          <button id="testToken" class="btn" style="padding:6px 10px">í† í° ê²€ì¦</button>
          <button id="logoutToken" class="btn" style="padding:6px 10px">í† í° ì§€ìš°ê¸°</button>
        </div>
      </div>
    </div>
    <div class="tiny" style="margin-top:6px">
      â€¢ í† í°ì€ ì½˜ì†”/DOMì— ê¸°ë¡í•˜ì§€ ì•Šìœ¼ë©°, <b>ì˜µì…˜ì„ ì¼  ê²½ìš°</b>ì—ë§Œ sessionStorageì— ì €ì¥ë©ë‹ˆë‹¤(íƒ­ ì¢…ë£Œ ì‹œ ì‚­ì œ).<br>
      â€¢ ê¶Œì¥: <b>Fine-grained PAT</b> Â· Repository: <span class="mono">storygineer</span> ì„ íƒ Â· Permissions â†’ <b>Contents: Read & Write</b>.<br>
      â€¢ Pagesê°€ <span class="mono">main/docs</span>ë©´ Branch=<span class="mono">main</span>, ê²½ë¡œ=<span class="mono">docs/submissions</span> ë“±ìœ¼ë¡œ ë§ì¶”ì„¸ìš”.
    </div>
  </section>

  <section class="card">
    <div class="row" style="align-items:flex-end">
      <button id="upload" class="btn primary">GitHubë¡œ ì—…ë¡œë“œ</button>
      <button id="download" class="btn">ëŒ€ì‹  ë¡œì»¬ë¡œ ì €ì¥</button>
      <span id="status" class="tiny"></span>
    </div>
    <div id="links" class="tiny" style="margin-top:8px"></div>
  </section>
</div>

<script>
/* ===== ê¸°ë³¸ ë©”ë‰´ ì œì•ˆ ===== */
const DEFAULT_MENUS=["ê¹€ì¹˜ì°Œê°œ","ëœì¥ì°Œê°œ","ë¹„ë¹”ë°¥","ë¶ˆê³ ê¸°","ì œìœ¡ë³¶ìŒ","ëƒ‰ë©´","ì¹¼êµ­ìˆ˜","ê¹€ë°¥","ë–¡ë³¶ì´","ìˆœëŒ€êµ­",
  "ë¶€ëŒ€ì°Œê°œ","ê°ìíƒ•","ì¹˜í‚¨","í”¼ì","íŒŒìŠ¤íƒ€","í–„ë²„ê±°","ìƒëŸ¬ë“œ","ì´ˆë°¥","ëˆì¹´ì¸ ","ë¼ë©˜","ìš°ë™",
  "ì§œì¥ë©´","ì§¬ë½•","íƒ•ìˆ˜ìœ¡","ë§ˆë¼íƒ•","ìŒ€êµ­ìˆ˜","íŒŸíƒ€ì´","ì¹´ë ˆ","ê·œë™","í¬ì¼€","ìˆœë‘ë¶€ì°Œê°œ","í•´ì¥êµ­",
  "ë³¶ìŒë°¥","ê°ˆë¹„íƒ•","ì„¤ë íƒ•","ì½©ë‚˜ë¬¼êµ­ë°¥","ë©”ë°€êµ­ìˆ˜"];
DEFAULT_MENUS.forEach(m=>{ const o=document.createElement('option'); o.value=m; (document.getElementById('suggest')).appendChild(o); });

/* ===== ë‚ ì§œ ê¸°ë³¸ê°’(Seoul) ===== */
const $date=document.getElementById('date');
const $todayTag=document.getElementById('todayTag');
(function initDate(){
  const now=new Date(); const tz=now.getTimezoneOffset(); const seoul=-9*60;
  const d=new Date(now.getTime() + (seoul - tz)*60000);
  $date.value = d.toISOString().slice(0,10);
  updateTodayTag();
})();
function updateTodayTag(){
  const ds=$date.value; if(!ds){ $todayTag.textContent='ë‚ ì§œ ë¯¸ì§€ì •'; return }
  const wd=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(ds+'T00:00:00').getDay()];
  $todayTag.textContent = `${ds} (${wd})`;
}

/* ===== DOM ===== */
const $name=document.getElementById('name');
const $m1=document.getElementById('m1');
const $m2=document.getElementById('m2');
const $m3=document.getElementById('m3');
const $owner=document.getElementById('owner');
const $repo=document.getElementById('repo');
const $branch=document.getElementById('branch');
const $subdir=document.getElementById('subdir');
const $token=document.getElementById('token');
const $rememberToken=document.getElementById('rememberToken');
const $testToken=document.getElementById('testToken');
const $logoutToken=document.getElementById('logoutToken');
const $upload=document.getElementById('upload');
const $download=document.getElementById('download');
const $status=document.getElementById('status');
const $links=document.getElementById('links');

/* ===== í† í° ì„¸ì…˜ ì €ì¥ ë„ìš°ë¯¸ ===== */
const TOKEN_KEY='__lunch_pat_session__';
function setSessionToken(tok){ try{ sessionStorage.setItem(TOKEN_KEY, tok || ''); }catch(_){} }
function getSessionToken(){ try{ return sessionStorage.getItem(TOKEN_KEY) || ''; }catch(_){ return '' } }
(function loadToken(){
  const t=getSessionToken();
  if(t){ $token.value=t; $rememberToken.checked=true; }
})();

function trim(s){return String(s||'').trim();}
function safeName(s){return trim(s).replace(/[^ã„±-í£a-zA-Z0-9._-]+/g,'_');}

/* ===== GitHub API helpers ===== */
async function ghGetContent({owner,repo,path,ref,token}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(ref)}`;
  const r=await fetch(url,{headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`}});
  if(r.status===404) return null;
  if(!r.ok) throw new Error(`GET ${path} ì‹¤íŒ¨: ${r.status} ${r.statusText}`);
  return r.json(); // includes sha
}
async function ghPutContent({owner,repo,path,branch,token,content,message,sha}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body={message, branch, content: btoa(unescape(encodeURIComponent(content)))};
  if(sha) body.sha=sha;
  const r=await fetch(url,{
    method:'PUT',
    headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok){
    const t=await r.text();
    throw new Error(`PUT ì‹¤íŒ¨: ${r.status} ${r.statusText} â€” ${t}`);
  }
  return r.json(); // {content:{path,html_url}, commit:{...}}
}
async function ghRepoReadme({owner,repo,token}){ // í† í° ê²€ì¦ìš©(ê¶Œí•œ ì²´í¬)
  const url=`https://api.github.com/repos/${owner}/${repo}/readme`;
  const r=await fetch(url,{headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`}});
  return r;
}

/* ===== í† í° ê²€ì¦/ê´€ë¦¬ ===== */
async function testToken(){
  $status.textContent='í† í° ê²€ì¦ ì¤‘...';
  $links.innerHTML='';
  const owner=trim($owner.value)||'shem0304';
  const repo=trim($repo.value)||'storygineer';
  const token=trim($token.value) || getSessionToken();
  if(!token){ $status.innerHTML='<span class="err">í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.</span>'; return; }
  try{
    const r=await ghRepoReadme({owner,repo,token});
    if(r.status===200){
      $status.innerHTML='<span class="ok">í† í° í™•ì¸ ì™„ë£Œ.</span> ì´ ì €ì¥ì†Œì— ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì“°ê¸° ê¶Œí•œì€ ì—…ë¡œë“œ ì‹œ ìµœì¢… í™•ì¸)';
      if($rememberToken.checked) setSessionToken(token);
    }else if(r.status===404){
      $status.innerHTML='<span class="warn">ì ‘ê·¼ ì‹¤íŒ¨.</span> ì €ì¥ì†Œê°€ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    }else if(r.status===401){
      $status.innerHTML='<span class="err">ì¸ì¦ ì‹¤íŒ¨.</span> í† í°ì´ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    }else{
      $status.innerHTML=`<span class="warn">ì‘ë‹µ ${r.status}.</span> ê¶Œí•œ/ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.`;
    }
  }catch(e){
    $status.innerHTML=`<span class="err">ê²€ì¦ ì˜¤ë¥˜:</span> ${e.message}`;
  }
}
function logoutToken(){
  $token.value='';
  setSessionToken('');
  $status.innerHTML='<span class="ok">í† í°ì„ ì´ íƒ­ì—ì„œ ì œê±°í–ˆìŠµë‹ˆë‹¤.</span>';
}

/* ===== Upload flow ===== */
async function uploadToGitHub(){
  $status.textContent='ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...';
  $links.innerHTML='';

  const name=trim($name.value);
  const date=trim($date.value);
  const picks=[trim($m1.value),trim($m2.value),trim($m3.value)];
  if(!name || !date || picks.some(x=>!x)){ $status.innerHTML='<span class="err">ì´ë¦„Â·ë‚ ì§œÂ·ë©”ë‰´3 ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.</span>'; return; }

  const owner=trim($owner.value)||'shem0304';
  const repo=trim($repo.value)||'storygineer';
  const branch=trim($branch.value)||'gh-pages';
  const subdir=trim($subdir.value||'');
  const token=trim($token.value) || getSessionToken();
  if(!token){ $status.innerHTML='<span class="err">GitHub í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>'; return; }
  if($rememberToken.checked) setSessionToken(token);

  const payload={version:'v1', name, date, picks};
  const json=JSON.stringify(payload,null,2);
  const fileName=`lunch_${date}_${safeName(name)}.json`;
  const dir = subdir ? `${subdir.replace(/^\/|\/$/g,'')}/${date}` : `${date}`;
  const path = `${dir}/${fileName}`;

  try{
    $status.textContent='íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸...';
    const existed = await ghGetContent({owner,repo,path,ref:branch,token});
    const sha = existed && existed.sha ? existed.sha : undefined;

    $status.textContent= sha ? 'ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸ ì¤‘...' : 'ì‹ ê·œ íŒŒì¼ ì—…ë¡œë“œ ì¤‘...';
    const msg = sha ? `update: ${path}` : `add: ${path}`;
    const res = await ghPutContent({owner,repo,path,branch,token,content:json,message:msg,sha});

    const htmlUrl = res?.content?.html_url || '';
    const pagesUrl = `https://${owner}.github.io/${repo}/${path}`;

    $status.innerHTML = `<span class="ok">ì™„ë£Œ!</span> ì»¤ë°‹ ë°˜ì˜ í›„ Pagesì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
    $links.innerHTML = `
      <div>â€¢ GitHub íŒŒì¼ í˜ì´ì§€: <a class="mono" target="_blank" rel="noopener" href="${htmlUrl}">${htmlUrl}</a></div>
      <div>â€¢ (ì˜ˆìƒ) Pages URL: <a class="mono" target="_blank" rel="noopener" href="${pagesUrl}">${pagesUrl}</a></div>
      <div class="tiny warn" style="margin-top:6px">â€» Pages ë¸Œëœì¹˜/ë””ë ‰í„°ë¦¬ ì„¤ì •ì— ë”°ë¼ URLì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    `;
  }catch(err){
    $status.innerHTML = `<span class="err">ì—…ë¡œë“œ ì‹¤íŒ¨:</span> ${err.message}<br>
      <span class="tiny">ê¶Œí•œ(Contents: Read & Write), ë¸Œëœì¹˜ëª…, ê²½ë¡œ, ë¸Œëœì¹˜ ë³´í˜¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</span>`;
  }
}

/* ===== Local download fallback ===== */
function downloadLocal(){
  const name=trim($name.value);
  const date=trim($date.value);
  const picks=[trim($m1.value),trim($m2.value),trim($m3.value)];
  if(!name || !date || picks.some(x=>!x)){ alert('ì´ë¦„Â·ë‚ ì§œÂ·ë©”ë‰´3 ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const payload={version:'v1', name, date, picks};
  const blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`lunch_${date}_${safeName(name)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== Bind ===== */
document.getElementById('upload').addEventListener('click', uploadToGitHub);
document.getElementById('download').addEventListener('click', downloadLocal);
$testToken.addEventListener('click', testToken);
$logoutToken.addEventListener('click', logoutToken);
</script>
</body>
</html>
