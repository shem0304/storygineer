<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[사용자용] 점심메뉴 제출 — GitHub 자동 업로드 (토큰 사용)</title>
<style>
  :root{--bg:#0b0d12;--card:#111520;--mut:#2a2f3a;--text:#e8ecf3;--sub:#8b95a7;--acc:#4da3ff}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);
       font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,sans-serif}
  .wrap{max-width:760px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--mut);border-radius:16px;padding:14px;margin-top:12px}
  label{font-weight:700}
  input[type="date"],input[type="text"],input[type="password"],textarea{width:100%;background:#0e1118;border:1px solid var(--mut);
        color:var(--text);padding:10px 12px;border-radius:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 180px}
  .btn{appearance:none;border:1px solid var(--mut);background:#121826;color:var(--text);
       padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;font-weight:700}
  .btn:hover{transform:translateY(-1px);border-color:var(--acc)}
  .btn.primary{background:var(--acc);color:#07121e;border-color:transparent}
  .tiny{font-size:12px;color:var(--sub)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .ok{color:#8fe18f}.warn{color:#ffd27d}.err{color:#ff9a9a}
</style>
</head>
<body>
<div class="wrap">
  <h1>🍱 점심메뉴 제출 — GitHub 자동 업로드</h1>
  <div class="tiny">이름·날짜·메뉴 3개 입력 → “GitHub로 업로드”를 누르면 <b>shem0304/storygineer</b> 저장소로 바로 업로드됩니다.</div>

  <section class="card">
    <div class="row">
      <div class="col"><label for="name">이름</label><input id="name" type="text" placeholder="본인 이름"></div>
      <div class="col"><label for="date">날짜</label><input id="date" type="date"><div id="todayTag" class="tiny"></div></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label for="m1">메뉴 1</label><input id="m1" type="text" list="suggest" placeholder="예: 김치찌개"></div>
      <div class="col"><label for="m2">메뉴 2</label><input id="m2" type="text" list="suggest" placeholder="예: 파스타"></div>
      <div class="col"><label for="m3">메뉴 3</label><input id="m3" type="text" list="suggest" placeholder="예: 초밥"></div>
    </div>
    <datalist id="suggest"></datalist>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px">GitHub 업로드 설정</h3>
    <div class="row">
      <div class="col"><label for="owner">Owner</label><input id="owner" type="text" value="shem0304"></div>
      <div class="col"><label for="repo">Repo</label><input id="repo" type="text" value="storygineer"></div>
      <div class="col"><label for="branch">Branch</label><input id="branch" type="text" value="gh-pages" placeholder="예: gh-pages 또는 main"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label for="subdir">업로드 하위 경로(선택)</label><input id="subdir" type="text" value="submissions" placeholder="예: submissions / docs/submissions"></div>
      <div class="col">
        <label for="token">GitHub 토큰 (Contents: Read & Write)</label>
        <input id="token" type="password" placeholder="Fine-grained PAT 입력 (저장 안 함)">
        <div class="tiny" style="margin-top:6px;display:flex;gap:10px;align-items:center">
          <label style="display:flex;align-items:center;gap:6px"><input id="rememberToken" type="checkbox">이 토큰을 <b>이 브라우저 탭</b>에만 기억</label>
          <button id="testToken" class="btn" style="padding:6px 10px">토큰 검증</button>
          <button id="logoutToken" class="btn" style="padding:6px 10px">토큰 지우기</button>
        </div>
      </div>
    </div>
    <div class="tiny" style="margin-top:6px">
      • 토큰은 콘솔/DOM에 기록하지 않으며, <b>옵션을 켠 경우</b>에만 sessionStorage에 저장됩니다(탭 종료 시 삭제).<br>
      • 권장: <b>Fine-grained PAT</b> · Repository: <span class="mono">storygineer</span> 선택 · Permissions → <b>Contents: Read & Write</b>.<br>
      • Pages가 <span class="mono">main/docs</span>면 Branch=<span class="mono">main</span>, 경로=<span class="mono">docs/submissions</span> 등으로 맞추세요.
    </div>
  </section>

  <section class="card">
    <div class="row" style="align-items:flex-end">
      <button id="upload" class="btn primary">GitHub로 업로드</button>
      <button id="download" class="btn">대신 로컬로 저장</button>
      <span id="status" class="tiny"></span>
    </div>
    <div id="links" class="tiny" style="margin-top:8px"></div>
  </section>
</div>

<script>
/* ===== 기본 메뉴 제안 ===== */
const DEFAULT_MENUS=["김치찌개","된장찌개","비빔밥","불고기","제육볶음","냉면","칼국수","김밥","떡볶이","순대국",
  "부대찌개","감자탕","치킨","피자","파스타","햄버거","샐러드","초밥","돈카츠","라멘","우동",
  "짜장면","짬뽕","탕수육","마라탕","쌀국수","팟타이","카레","규동","포케","순두부찌개","해장국",
  "볶음밥","갈비탕","설렁탕","콩나물국밥","메밀국수"];
DEFAULT_MENUS.forEach(m=>{ const o=document.createElement('option'); o.value=m; (document.getElementById('suggest')).appendChild(o); });

/* ===== 날짜 기본값(Seoul) ===== */
const $date=document.getElementById('date');
const $todayTag=document.getElementById('todayTag');
(function initDate(){
  const now=new Date(); const tz=now.getTimezoneOffset(); const seoul=-9*60;
  const d=new Date(now.getTime() + (seoul - tz)*60000);
  $date.value = d.toISOString().slice(0,10);
  updateTodayTag();
})();
function updateTodayTag(){
  const ds=$date.value; if(!ds){ $todayTag.textContent='날짜 미지정'; return }
  const wd=['일','월','화','수','목','금','토'][new Date(ds+'T00:00:00').getDay()];
  $todayTag.textContent = `${ds} (${wd})`;
}

/* ===== DOM ===== */
const $name=document.getElementById('name');
const $m1=document.getElementById('m1');
const $m2=document.getElementById('m2');
const $m3=document.getElementById('m3');
const $owner=document.getElementById('owner');
const $repo=document.getElementById('repo');
const $branch=document.getElementById('branch');
const $subdir=document.getElementById('subdir');
const $token=document.getElementById('token');
const $rememberToken=document.getElementById('rememberToken');
const $testToken=document.getElementById('testToken');
const $logoutToken=document.getElementById('logoutToken');
const $upload=document.getElementById('upload');
const $download=document.getElementById('download');
const $status=document.getElementById('status');
const $links=document.getElementById('links');

/* ===== 토큰 세션 저장 도우미 ===== */
const TOKEN_KEY='__lunch_pat_session__';
function setSessionToken(tok){ try{ sessionStorage.setItem(TOKEN_KEY, tok || ''); }catch(_){} }
function getSessionToken(){ try{ return sessionStorage.getItem(TOKEN_KEY) || ''; }catch(_){ return '' } }
(function loadToken(){
  const t=getSessionToken();
  if(t){ $token.value=t; $rememberToken.checked=true; }
})();

function trim(s){return String(s||'').trim();}
function safeName(s){return trim(s).replace(/[^ㄱ-힣a-zA-Z0-9._-]+/g,'_');}

/* ===== GitHub API helpers ===== */
async function ghGetContent({owner,repo,path,ref,token}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(ref)}`;
  const r=await fetch(url,{headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`}});
  if(r.status===404) return null;
  if(!r.ok) throw new Error(`GET ${path} 실패: ${r.status} ${r.statusText}`);
  return r.json(); // includes sha
}
async function ghPutContent({owner,repo,path,branch,token,content,message,sha}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body={message, branch, content: btoa(unescape(encodeURIComponent(content)))};
  if(sha) body.sha=sha;
  const r=await fetch(url,{
    method:'PUT',
    headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok){
    const t=await r.text();
    throw new Error(`PUT 실패: ${r.status} ${r.statusText} — ${t}`);
  }
  return r.json(); // {content:{path,html_url}, commit:{...}}
}
async function ghRepoReadme({owner,repo,token}){ // 토큰 검증용(권한 체크)
  const url=`https://api.github.com/repos/${owner}/${repo}/readme`;
  const r=await fetch(url,{headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`}});
  return r;
}

/* ===== 토큰 검증/관리 ===== */
async function testToken(){
  $status.textContent='토큰 검증 중...';
  $links.innerHTML='';
  const owner=trim($owner.value)||'shem0304';
  const repo=trim($repo.value)||'storygineer';
  const token=trim($token.value) || getSessionToken();
  if(!token){ $status.innerHTML='<span class="err">토큰을 입력하세요.</span>'; return; }
  try{
    const r=await ghRepoReadme({owner,repo,token});
    if(r.status===200){
      $status.innerHTML='<span class="ok">토큰 확인 완료.</span> 이 저장소에 접근 가능합니다. (쓰기 권한은 업로드 시 최종 확인)';
      if($rememberToken.checked) setSessionToken(token);
    }else if(r.status===404){
      $status.innerHTML='<span class="warn">접근 실패.</span> 저장소가 없거나 권한이 없습니다.';
    }else if(r.status===401){
      $status.innerHTML='<span class="err">인증 실패.</span> 토큰이 잘못되었거나 만료되었습니다.';
    }else{
      $status.innerHTML=`<span class="warn">응답 ${r.status}.</span> 권한/설정을 확인하세요.`;
    }
  }catch(e){
    $status.innerHTML=`<span class="err">검증 오류:</span> ${e.message}`;
  }
}
function logoutToken(){
  $token.value='';
  setSessionToken('');
  $status.innerHTML='<span class="ok">토큰을 이 탭에서 제거했습니다.</span>';
}

/* ===== Upload flow ===== */
async function uploadToGitHub(){
  $status.textContent='업로드 준비 중...';
  $links.innerHTML='';

  const name=trim($name.value);
  const date=trim($date.value);
  const picks=[trim($m1.value),trim($m2.value),trim($m3.value)];
  if(!name || !date || picks.some(x=>!x)){ $status.innerHTML='<span class="err">이름·날짜·메뉴3 모두 입력하세요.</span>'; return; }

  const owner=trim($owner.value)||'shem0304';
  const repo=trim($repo.value)||'storygineer';
  const branch=trim($branch.value)||'gh-pages';
  const subdir=trim($subdir.value||'');
  const token=trim($token.value) || getSessionToken();
  if(!token){ $status.innerHTML='<span class="err">GitHub 토큰이 필요합니다.</span>'; return; }
  if($rememberToken.checked) setSessionToken(token);

  const payload={version:'v1', name, date, picks};
  const json=JSON.stringify(payload,null,2);
  const fileName=`lunch_${date}_${safeName(name)}.json`;
  const dir = subdir ? `${subdir.replace(/^\/|\/$/g,'')}/${date}` : `${date}`;
  const path = `${dir}/${fileName}`;

  try{
    $status.textContent='파일 존재 여부 확인...';
    const existed = await ghGetContent({owner,repo,path,ref:branch,token});
    const sha = existed && existed.sha ? existed.sha : undefined;

    $status.textContent= sha ? '기존 파일 업데이트 중...' : '신규 파일 업로드 중...';
    const msg = sha ? `update: ${path}` : `add: ${path}`;
    const res = await ghPutContent({owner,repo,path,branch,token,content:json,message:msg,sha});

    const htmlUrl = res?.content?.html_url || '';
    const pagesUrl = `https://${owner}.github.io/${repo}/${path}`;

    $status.innerHTML = `<span class="ok">완료!</span> 커밋 반영 후 Pages에서 접근 가능합니다.`;
    $links.innerHTML = `
      <div>• GitHub 파일 페이지: <a class="mono" target="_blank" rel="noopener" href="${htmlUrl}">${htmlUrl}</a></div>
      <div>• (예상) Pages URL: <a class="mono" target="_blank" rel="noopener" href="${pagesUrl}">${pagesUrl}</a></div>
      <div class="tiny warn" style="margin-top:6px">※ Pages 브랜치/디렉터리 설정에 따라 URL이 다를 수 있습니다.</div>
    `;
  }catch(err){
    $status.innerHTML = `<span class="err">업로드 실패:</span> ${err.message}<br>
      <span class="tiny">권한(Contents: Read & Write), 브랜치명, 경로, 브랜치 보호 설정을 확인하세요.</span>`;
  }
}

/* ===== Local download fallback ===== */
function downloadLocal(){
  const name=trim($name.value);
  const date=trim($date.value);
  const picks=[trim($m1.value),trim($m2.value),trim($m3.value)];
  if(!name || !date || picks.some(x=>!x)){ alert('이름·날짜·메뉴3 모두 입력하세요.'); return; }
  const payload={version:'v1', name, date, picks};
  const blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`lunch_${date}_${safeName(name)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== Bind ===== */
document.getElementById('upload').addEventListener('click', uploadToGitHub);
document.getElementById('download').addEventListener('click', downloadLocal);
$testToken.addEventListener('click', testToken);
$logoutToken.addEventListener('click', logoutToken);
</script>
</body>
</html>
