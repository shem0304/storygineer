<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[ì‚¬ìš©ììš©] ì ì‹¬ë©”ë‰´ ì œì¶œ â€” GitHub ìë™ ì—…ë¡œë“œ</title>
<style>
  :root{--bg:#0b0d12;--card:#111520;--mut:#2a2f3a;--text:#e8ecf3;--sub:#8b95a7;--acc:#4da3ff}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0d12,#0f1320);color:var(--text);
       font:15.5px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Noto Sans KR,sans-serif}
  .wrap{max-width:760px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--mut);border-radius:16px;padding:14px;margin-top:12px}
  label{font-weight:700}
  input[type="date"],input[type="text"],input[type="password"],textarea{width:100%;background:#0e1118;border:1px solid var(--mut);
        color:var(--text);padding:10px 12px;border-radius:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 180px}
  .btn{appearance:none;border:1px solid var(--mut);background:#121826;color:var(--text);
       padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;font-weight:700}
  .btn:hover{transform:translateY(-1px);border-color:var(--acc)}
  .btn.primary{background:var(--acc);color:#07121e;border-color:transparent}
  .tiny{font-size:12px;color:var(--sub)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .ok{color:#8fe18f}.warn{color:#ffd27d}.err{color:#ff9a9a}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ± ì ì‹¬ë©”ë‰´ ì œì¶œ â€” GitHub ìë™ ì—…ë¡œë“œ</h1>
  <div class="tiny">ì´ë¦„Â·ë‚ ì§œÂ·ë©”ë‰´ 3ê°œ ì…ë ¥ â†’ â€œGitHubë¡œ ì—…ë¡œë“œâ€ë¥¼ ëˆ„ë¥´ë©´ <b>shem0304/storygineer</b> ì €ì¥ì†Œë¡œ ë°”ë¡œ ì—…ë¡œë“œë©ë‹ˆë‹¤.</div>

  <section class="card">
    <div class="row">
      <div class="col"><label for="name">ì´ë¦„</label><input id="name" type="text" placeholder="ë³¸ì¸ ì´ë¦„"></div>
      <div class="col"><label for="date">ë‚ ì§œ</label><input id="date" type="date"><div id="todayTag" class="tiny"></div></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label for="m1">ë©”ë‰´ 1</label><input id="m1" type="text" list="suggest" placeholder="ì˜ˆ: ê¹€ì¹˜ì°Œê°œ"></div>
      <div class="col"><label for="m2">ë©”ë‰´ 2</label><input id="m2" type="text" list="suggest" placeholder="ì˜ˆ: íŒŒìŠ¤íƒ€"></div>
      <div class="col"><label for="m3">ë©”ë‰´ 3</label><input id="m3" type="text" list="suggest" placeholder="ì˜ˆ: ì´ˆë°¥"></div>
    </div>
    <datalist id="suggest"></datalist>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px">GitHub ì—…ë¡œë“œ ì„¤ì •</h3>
    <div class="row">
      <div class="col"><label for="owner">Owner</label><input id="owner" type="text" value="shem0304"></div>
      <div class="col"><label for="repo">Repo</label><input id="repo" type="text" value="storygineer"></div>
      <div class="col"><label for="branch">Branch</label><input id="branch" type="text" value="gh-pages" placeholder="ì˜ˆ: gh-pages ë˜ëŠ” main"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label for="subdir">ì—…ë¡œë“œ í•˜ìœ„ ê²½ë¡œ(ì„ íƒ)</label><input id="subdir" type="text" value="submissions" placeholder="ì˜ˆ: submissions / docs/submissions"></div>
      <div class="col"><label for="token">GitHub í† í° (repo contents ê¶Œí•œ)</label><input id="token" type="password" placeholder="PAT í† í° ì…ë ¥ (ì €ì¥ë˜ì§€ ì•ŠìŒ)"></div>
    </div>
    <div class="tiny" style="margin-top:6px">
      â€¢ í† í°ì€ <b>ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ì—ì„œë§Œ ì‚¬ìš©</b>í•˜ê³  ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì•ˆì „ì„ ìœ„í•´ <b>fine-grained PAT</b>ë¡œ í•´ë‹¹ ì €ì¥ì†Œì— <b>Contents: Read & Write</b> ê¶Œí•œë§Œ ë¶€ì—¬í•˜ì„¸ìš”.<br>
      â€¢ GitHub Pagesê°€ <span class="mono">gh-pages</span>ê°€ ì•„ë‹Œ <span class="mono">main/docs</span>ì„ ì“°ë©´ Branchë¥¼ <span class="mono">main</span>, ê²½ë¡œë¥¼ <span class="mono">docs/submissions</span> ë“±ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”.
    </div>
  </section>

  <section class="card">
    <div class="row" style="align-items:flex-end">
      <button id="upload" class="btn primary">GitHubë¡œ ì—…ë¡œë“œ</button>
      <button id="download" class="btn">ëŒ€ì‹  ë¡œì»¬ë¡œ ì €ì¥</button>
      <span id="status" class="tiny"></span>
    </div>
    <div id="links" class="tiny" style="margin-top:8px"></div>
  </section>
</div>

<script>
/* ===== ê¸°ë³¸ ë©”ë‰´ ì œì•ˆ ===== */
const DEFAULT_MENUS=["ê¹€ì¹˜ì°Œê°œ","ëœì¥ì°Œê°œ","ë¹„ë¹”ë°¥","ë¶ˆê³ ê¸°","ì œìœ¡ë³¶ìŒ","ëƒ‰ë©´","ì¹¼êµ­ìˆ˜","ê¹€ë°¥","ë–¡ë³¶ì´","ìˆœëŒ€êµ­",
  "ë¶€ëŒ€ì°Œê°œ","ê°ìíƒ•","ì¹˜í‚¨","í”¼ì","íŒŒìŠ¤íƒ€","í–„ë²„ê±°","ìƒëŸ¬ë“œ","ì´ˆë°¥","ëˆì¹´ì¸ ","ë¼ë©˜","ìš°ë™",
  "ì§œì¥ë©´","ì§¬ë½•","íƒ•ìˆ˜ìœ¡","ë§ˆë¼íƒ•","ìŒ€êµ­ìˆ˜","íŒŸíƒ€ì´","ì¹´ë ˆ","ê·œë™","í¬ì¼€","ìˆœë‘ë¶€ì°Œê°œ","í•´ì¥êµ­",
  "ë³¶ìŒë°¥","ê°ˆë¹„íƒ•","ì„¤ë íƒ•","ì½©ë‚˜ë¬¼êµ­ë°¥","ë©”ë°€êµ­ìˆ˜"];
DEFAULT_MENUS.forEach(m=>{ const o=document.createElement('option'); o.value=m; (document.getElementById('suggest')).appendChild(o); });

/* ===== ë‚ ì§œ ê¸°ë³¸ê°’(Seoul) ===== */
const $date=document.getElementById('date');
const $todayTag=document.getElementById('todayTag');
(function initDate(){
  const now=new Date(); const tz=now.getTimezoneOffset(); const seoul=-9*60;
  const d=new Date(now.getTime() + (seoul - tz)*60000);
  $date.value = d.toISOString().slice(0,10);
  updateTodayTag();
})();
function updateTodayTag(){
  const ds=$date.value; if(!ds){ $todayTag.textContent='ë‚ ì§œ ë¯¸ì§€ì •'; return }
  const wd=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(ds+'T00:00:00').getDay()];
  $todayTag.textContent = `${ds} (${wd})`;
}

/* ===== DOM ===== */
const $name=document.getElementById('name');
const $m1=document.getElementById('m1');
const $m2=document.getElementById('m2');
const $m3=document.getElementById('m3');
const $owner=document.getElementById('owner');
const $repo=document.getElementById('repo');
const $branch=document.getElementById('branch');
const $subdir=document.getElementById('subdir');
const $token=document.getElementById('token');
const $upload=document.getElementById('upload');
const $download=document.getElementById('download');
const $status=document.getElementById('status');
const $links=document.getElementById('links');

function trim(s){return String(s||'').trim();}
function safeName(s){return trim(s).replace(/[^ã„±-í£a-zA-Z0-9._-]+/g,'_');}

/* ===== GitHub API helpers ===== */
async function ghGetContent({owner,repo,path,ref,token}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(ref)}`;
  const r=await fetch(url,{headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`}}); 
  if(r.status===404) return null;
  if(!r.ok) throw new Error(`GET ${path} ì‹¤íŒ¨: ${r.status} ${r.statusText}`);
  return r.json(); // includes sha
}
async function ghPutContent({owner,repo,path,branch,token,content,message,sha}){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body={message, branch, content: btoa(unescape(encodeURIComponent(content)))};
  if(sha) body.sha=sha;
  const r=await fetch(url,{
    method:'PUT',
    headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok){
    const t=await r.text();
    throw new Error(`PUT ì‹¤íŒ¨: ${r.status} ${r.statusText} â€” ${t}`);
  }
  return r.json(); // {content:{path,html_url}, commit:{...}}
}

/* ===== Upload flow ===== */
async function uploadToGitHub(){
  $status.textContent='ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...';
  $links.innerHTML='';
  const name=trim($name.value);
  const date=trim($date.value);
  const picks=[trim($m1.value),trim($m2.value),trim($m3.value)];
  if(!name || !date || picks.some(x=>!x)){ $status.innerHTML='<span class="err">ì´ë¦„Â·ë‚ ì§œÂ·ë©”ë‰´3 ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.</span>'; return; }

  const owner=trim($owner.value)||'shem0304';
  const repo=trim($repo.value)||'storygineer';
  const branch=trim($branch.value)||'gh-pages';
  const subdir=trim($subdir.value||'');
  const token=trim($token.value);
  if(!token){ $status.innerHTML='<span class="err">GitHub í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>'; return; }

  const payload={version:'v1', name, date, picks};
  const json=JSON.stringify(payload,null,2);
  const fileName=`lunch_${date}_${safeName(name)}.json`;
  const dir = subdir ? `${subdir.replace(/^\/|\/$/g,'')}/${date}` : `${date}`;
  const path = `${dir}/${fileName}`;

  try{
    $status.textContent='íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸...';
    const existed = await ghGetContent({owner,repo,path,ref:branch,token});
    const sha = existed && existed.sha ? existed.sha : undefined;

    $status.textContent= sha ? 'ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸ ì¤‘...' : 'ì‹ ê·œ íŒŒì¼ ì—…ë¡œë“œ ì¤‘...';
    const msg = sha ? `update: ${path}` : `add: ${path}`;
    const res = await ghPutContent({owner,repo,path,branch,token,content:json,message:msg,sha});

    const htmlUrl = res && res.content && res.content.html_url ? res.content.html_url : '';
    // (ê°€ì •) GitHub Pagesì—ì„œ ë™ì¼ ë¸Œëœì¹˜/ê²½ë¡œë¥¼ ì„œë¹„ìŠ¤í•  ë•Œ ì ‘ê·¼ ê°€ëŠ¥í•  URL ì¶”ì •
    const pagesUrl = `https://${owner}.github.io/${repo}/${path}`;

    $status.innerHTML = `<span class="ok">ì™„ë£Œ!</span> ì»¤ë°‹ì´ ë°˜ì˜ë˜ë©´ Pagesì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.`;
    $links.innerHTML = `
      <div>â€¢ GitHub íŒŒì¼ í˜ì´ì§€: <a class="mono" target="_blank" rel="noopener" href="${htmlUrl}">${htmlUrl}</a></div>
      <div>â€¢ (ì˜ˆìƒ) Pages URL: <a class="mono" target="_blank" rel="noopener" href="${pagesUrl}">${pagesUrl}</a></div>
      <div class="tiny warn" style="margin-top:6px">â€» Pages ë¸Œëœì¹˜/ë””ë ‰í„°ë¦¬ê°€ ë‹¤ë¥´ë©´ ìœ„ Pages URLì´ ë°”ë¡œ ë³´ì´ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ Pages ì„¤ì •(ë¸Œëœì¹˜/í´ë”)ì„ í™•ì¸í•˜ì„¸ìš”.</div>
    `;
  }catch(err){
    console.error(err);
    $status.innerHTML = `<span class="err">ì—…ë¡œë“œ ì‹¤íŒ¨:</span> ${err.message}`;
  }
}

/* ===== Local download fallback ===== */
function downloadLocal(){
  const name=trim($name.value);
  const date=trim($date.value);
  const picks=[trim($m1.value),trim($m2.value),trim($m3.value)];
  if(!name || !date || picks.some(x=>!x)){ alert('ì´ë¦„Â·ë‚ ì§œÂ·ë©”ë‰´3 ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const payload={version:'v1', name, date, picks};
  const blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`lunch_${date}_${safeName(name)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== Bind ===== */
document.getElementById('upload').addEventListener('click', ()=>{
  uploadToGitHub();
});
document.getElementById('download').addEventListener('click', ()=>{
  downloadLocal();
});
</script>
</body>
</html>
