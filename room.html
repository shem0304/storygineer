<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>울산연구원 3층 회의실 예약관리</title>
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --ink:#1f2937; --muted:#6b7280; --pri:#2563eb; --pri-ink:#fff; --line:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color:var(--ink); background:var(--bg); }
    .wrap { max-width: 980px; margin: 24px auto 80px; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
    h1 { font-size: 20px; margin: 0; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    .form { padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .form .full { grid-column: 1/-1; }
    label { display:block; font-size: 12px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], input[type="datetime-local"], input[type="search"] { width:100%; border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px; background:#fff; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    button { appearance:none; border:none; border-radius:10px; padding:10px 14px; font-size:14px; cursor:pointer; }
    .btn { background:var(--pri); color:var(--pri-ink); }
    .btn.sec { background:#e5e7eb; color:#111827; }
    .btn.ghost { background:transparent; color:var(--muted); }
    .toolbar { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-top:1px solid var(--line); }
    .table-wrap { overflow:auto; border-top:1px solid var(--line); }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:12px 10px; text-align:left; border-bottom:1px solid var(--line); font-size: 14px; }
    th { background:#fafafa; position:sticky; top:0; z-index:1; }
    tr:hover td { background:#fafcff; }
    .muted { color:var(--muted); }
    .chip { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .danger { color:#b91c1c; }
    footer { margin-top:16px; color:var(--muted); font-size:12px; text-align:center; }
    @media (max-width: 700px) { .form { grid-template-columns:1fr; } .toolbar { flex-direction:column; gap:10px; align-items:stretch; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>울산연구원 3층 회의실 · 예약관리</h1>
      <div class="chip" id="roomStatus">단일 회의실</div>
    </header>

    <section class="card" aria-label="예약 등록">
      <form id="bookingForm" class="form" autocomplete="off">
        <div>
          <label for="title">회의명 *</label>
          <input id="title" name="title" type="text" placeholder="예: 정례회의" required />
        </div>
        <div>
          <label for="dt">예약일시 *</label>
          <input id="dt" name="dt" type="datetime-local" required />
        </div>
        <div>
          <label for="owner">예약자 *</label>
          <input id="owner" name="owner" type="text" placeholder="예: 김박사" required />
        </div>
        <div>
          <label for="duration">소요시간(분)</label>
          <input id="duration" name="duration" type="text" inputmode="numeric" pattern="^\d{1,3}$" placeholder="기본 60" />
        </div>
        <div class="full row">
          <button class="btn" type="submit" id="submitBtn">등록</button>
          <button class="btn sec" type="reset" id="resetBtn">초기화</button>
          <button class="btn ghost" type="button" id="demoBtn" title="샘플 데이터 추가">샘플</button>
        </div>
      </form>
      <div class="toolbar">
        <div class="row" role="group" aria-label="검색 및 정렬">
          <input id="search" type="search" placeholder="검색: 회의명/예약자" />
          <button class="btn sec" type="button" id="sortBtn">시간순 정렬</button>
        </div>
        <div class="row">
          <button class="btn sec" type="button" id="exportBtn">CSV 내보내기</button>
          <button class="btn ghost" type="button" id="clearAllBtn"><span class="danger">전체삭제</span></button>
        </div>
      </div>
      <div class="table-wrap">
        <table aria-describedby="roomStatus">
          <thead>
            <tr>
              <th style="width:38%">회의명</th>
              <th style="width:26%">예약일시</th>
              <th style="width:18%">예약자</th>
              <th style="width:18%">작업</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="muted">등록된 예약이 없습니다.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer>
      <p>데이터는 브라우저(LocalStorage)에 저장됩니다 · 키: <code>uirc-3f-reservations</code></p>
    </footer>
  </div>

  <template id="rowTemplate">
    <tr>
      <td class="td-title"></td>
      <td class="td-dt"></td>
      <td class="td-owner"></td>
      <td>
        <div class="row">
          <button class="btn sec btn-edit" type="button">수정</button>
          <button class="btn ghost btn-del" type="button"><span class="danger">삭제</span></button>
        </div>
      </td>
    </tr>
  </template>

  <script>
    (function() {
      const KEY = 'uirc-3f-reservations';
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const form = $('#bookingForm');
      const tbody = $('#tbody');
      const rowTpl = $('#rowTemplate');
      const searchInput = $('#search');
      const sortBtn = $('#sortBtn');
      const exportBtn = $('#exportBtn');
      const clearAllBtn = $('#clearAllBtn');
      const demoBtn = $('#demoBtn');
      const submitBtn = $('#submitBtn');

      let editingId = null; // 현재 수정 중인 항목의 id

      const load = () => {
        try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch(e){ return []; }
      };
      const save = (rows) => localStorage.setItem(KEY, JSON.stringify(rows));

      const toIso = (v) => new Date(v).toISOString();
      const fmt = (iso) => {
        const d = new Date(iso);
        if (isNaN(d)) return '';
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${y}-${m}-${day} ${hh}:${mm}`;
      };

      const getDuration = () => {
        const raw = $('#duration').value.trim();
        const n = Number(raw || 60);
        return Number.isFinite(n) && n > 0 ? Math.min(n, 600) : 60; // 최대 10시간
      };

      const upsert = (row) => {
        const rows = load();
        const idx = rows.findIndex(r => r.id === row.id);
        if (idx >= 0) rows[idx] = row; else rows.push(row);
        save(rows);
        render();
      };

      const remove = (id) => {
        const rows = load().filter(r => r.id !== id);
        save(rows); render();
      };

      const render = () => {
        const q = searchInput.value.trim().toLowerCase();
        const rows = load().sort((a,b) => new Date(a.dt) - new Date(b.dt));
        tbody.innerHTML = '';
        const visible = rows.filter(r => !q || [r.title, r.owner, fmt(r.dt)].some(x => String(x).toLowerCase().includes(q)));
        if (!visible.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td'); td.colSpan = 4; td.className = 'muted'; td.textContent = '등록된 예약이 없습니다.';
          tr.appendChild(td); tbody.appendChild(tr); return;
        }
        for (const r of visible) {
          const tr = rowTpl.content.firstElementChild.cloneNode(true);
          $('.td-title', tr).textContent = r.title;
          $('.td-owner', tr).textContent = r.owner;
          $('.td-dt', tr).textContent = fmt(r.dt) + (r.duration ? ` · ${r.duration}분` : '');
          $('.btn-edit', tr).addEventListener('click', () => startEdit(r.id));
          $('.btn-del', tr).addEventListener('click', () => {
            if (confirm('이 예약을 삭제할까요?')) remove(r.id);
          });
          tbody.appendChild(tr);
        }
      };

      const startEdit = (id) => {
        const r = load().find(x => x.id === id); if (!r) return;
        editingId = id;
        $('#title').value = r.title;
        $('#owner').value = r.owner;
        $('#dt').value = new Date(r.dt).toISOString().slice(0,16);
        $('#duration').value = r.duration || '';
        submitBtn.textContent = '수정 저장';
      };

      const resetForm = () => {
        editingId = null;
        form.reset();
        submitBtn.textContent = '등록';
      };

      const hasConflict = (iso, excludeId=null) => {
        // 단일 회의실: 동일 시작시각 충돌만 단순 체크 (기간 충돌은 미구현)
        const rows = load();
        return rows.some(r => r.dt === iso && r.id !== excludeId);
      };

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const title = $('#title').value.trim();
        const owner = $('#owner').value.trim();
        const dtRaw = $('#dt').value;
        if (!title || !owner || !dtRaw) return alert('필수 항목을 입력하세요.');
        const iso = toIso(dtRaw);
        if (!iso || isNaN(new Date(iso))) return alert('예약일시가 올바르지 않습니다.');
        if (new Date(iso).getTime() < Date.now() - 60_000) {
          if(!confirm('과거 시각입니다. 그래도 등록할까요?')) return;
        }
        const duration = getDuration();
        if (hasConflict(iso, editingId)) return alert('해당 시각에 이미 예약이 있습니다.');
        const row = {
          id: editingId || crypto.randomUUID(),
          title, owner, dt: iso, duration
        };
        upsert(row);
        resetForm();
      });

      form.addEventListener('reset', () => setTimeout(resetForm, 0));

      searchInput.addEventListener('input', render);
      sortBtn.addEventListener('click', () => { render(); });

      exportBtn.addEventListener('click', () => {
        const rows = load().sort((a,b) => new Date(a.dt) - new Date(b.dt));
        const header = ['회의명','예약일시','예약자','소요(분)'];
        const lines = [header.join(',')].concat(rows.map(r => [
          escapeCSV(r.title), fmt(r.dt), escapeCSV(r.owner), r.duration||''
        ].join(',')));
        const blob = new Blob(['\ufeff' + lines.join('\n')], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = '울산연구원_3층회의실_예약목록.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      clearAllBtn.addEventListener('click', () => {
        if (confirm('모든 예약을 삭제할까요?')) { localStorage.removeItem(KEY); render(); }
      });

      demoBtn.addEventListener('click', () => {
        if (!confirm('샘플 데이터를 추가할까요?')) return;
        const base = new Date();
        base.setMinutes(0,0,0);
        const rows = [
          { id: crypto.randomUUID(), title:'정례회의', owner:'김박사', dt: new Date(base.getTime()+ 2*60*60*1000).toISOString(), duration:60 },
          { id: crypto.randomUUID(), title:'프로젝트 킥오프', owner:'박연구', dt: new Date(base.getTime()+ 4*60*60*1000).toISOString(), duration:90 },
          { id: crypto.randomUUID(), title:'보고 준비', owner:'이대리', dt: new Date(base.getTime()+ 26*60*60*1000).toISOString(), duration:60 }
        ];
        const cur = load(); save(cur.concat(rows)); render();
      });

      const escapeCSV = (v) => {
        const s = String(v ?? '');
        if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
        return s;
      };

      // 초기 렌더링
      render();
    })();
  </script>
</body>
</html>
