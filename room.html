<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>울산연구원 3층 회의실 예약관리</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --card: #111827; /* gray-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #38bdf8; /* sky-400 */
      --ok: #22c55e; /* green-500 */
      --bad: #ef4444; /* red-500 */
      --warn: #f59e0b; /* amber-500 */
      --border: #1f2937; /* gray-800 */
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple SD Gothic Neo, "맑은 고딕", sans-serif;
      background: linear-gradient(120deg, #0b1020, #0a142c 55%, #0b1020);
      color: var(--text);
    }
    .wrap { max-width: 1100px; margin: 24px auto 80px; padding: 0 16px; }
    h1 { font-size: 24px; margin: 12px 0 20px; display:flex; align-items:center; gap:10px; }
    .badge { font-size: 12px; color: var(--bg); background: var(--accent); padding: 2px 8px; border-radius: 999px; }

    .toolbar { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:14px; align-items:center; }
    .toolbar button, .toolbar .right button { 
      background:#0b2540; color:#dbeafe; border:1px solid #1e3a8a; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; 
    }
    .toolbar button:hover { filter: brightness(1.1); }
    .toolbar .right { margin-left:auto; display:flex; gap:10px; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 4px; }

    .grid { display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; align-items:start; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { background: rgba(17,24,39,.7); backdrop-filter: blur(6px); border:1px solid var(--border); border-radius:16px; }
    .card h2 { font-size:18px; margin: 0 0 10px; }
    .card .inner { padding:16px; }

    .form { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .form label { font-size:12px; color: var(--muted); display:block; margin-bottom:6px; }
    .form input, .form select, .form textarea { width:100%; box-sizing:border-box; 
      background:#0b1020; color: var(--text); border:1px solid var(--border); border-radius:12px; padding:10px; }
    .form textarea { min-height:72px; grid-column: 1 / -1; resize: vertical; }
    .form .row { display:flex; gap:12px; }
    .form .full { grid-column: 1 / -1; }
    .form .actions { display:flex; gap:10px; }
    .btn-primary { background:#0b2540; color:#dbeafe; border:1px solid #1e3a8a; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700; }
    .btn-secondary { background:transparent; color:#cbd5e1; border:1px dashed #334155; padding:10px 12px; border-radius:12px; cursor:pointer; }
    .btn-danger { background:#2a0b10; color:#fecaca; border:1px solid #7f1d1d; padding:10px 12px; border-radius:12px; cursor:pointer; }

    .table-wrap { overflow:auto; max-height: 60vh; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid var(--border); font-size:14px; }
    th { text-align:left; position: sticky; top: 0; background: #0a132a; z-index: 1; }
    tr:hover { background: rgba(59,130,246,0.07); }

    .status { font-size: 12px; padding: 4px 8px; border-radius: 999px; display:inline-block; }
    .ok { background: rgba(34,197,94,.15); color:#86efac; border:1px solid rgba(34,197,94,.3); }
    .bad { background: rgba(239,68,68,.15); color:#fecaca; border:1px solid rgba(239,68,68,.3); }
    .warn { background: rgba(245,158,11,.15); color:#fde68a; border:1px solid rgba(245,158,11,.3); }

    .search { display:flex; gap:10px; margin-bottom:10px; }
    .search input { flex:1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; color: #a5b4fc; }
    .foot { margin-top: 14px; color: var(--muted); font-size: 12px; }
    .link { color:#93c5fd; text-decoration: underline; cursor: pointer; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>울산연구원 <strong>3층 회의실 예약관리</strong> <span class="badge">room.txt 연동</span></h1>

    <div class="toolbar">
      <button id="btnOpen">room.txt 열기</button>
      <button id="btnSave">저장하기</button>
      <button id="btnExport">다운로드(.txt)</button>
      <button id="btnImport">가져오기(.txt)</button>
      <span class="hint">※ Chrome/Edge 등에서 파일 권한 허용 시 room.txt에 직접 저장됩니다. 지원되지 않으면 다운로드/가져오기를 사용하세요.</span>
    </div>

    <div class="grid">
      <section class="card">
        <div class="inner">
          <h2>예약 등록</h2>
          <form id="frm" class="form">
            <div class="full">
              <label>회의명</label>
              <input type="text" id="title" required placeholder="예: 정책세미나 실무 간담회" />
            </div>
            <div>
              <label>시작일시</label>
              <input type="datetime-local" id="start" required />
            </div>
            <div>
              <label>종료일시</label>
              <input type="datetime-local" id="end" required />
            </div>
            <div>
              <label>예약자 성명</label>
              <input type="text" id="name" required placeholder="홍길동" />
            </div>
            <div>
              <label>부서</label>
              <input type="text" id="dept" placeholder="정책연구실" />
            </div>
            <div>
              <label>연락처</label>
              <input type="tel" id="phone" placeholder="010-1234-5678" />
            </div>
            <div class="full">
              <label>비고</label>
              <textarea id="note" placeholder="준비물, 참석자 등"></textarea>
            </div>
            <div class="full actions">
              <button type="submit" class="btn-primary">예약 추가</button>
              <button type="button" id="btnClear" class="btn-secondary">입력 초기화</button>
            </div>
            <input type="hidden" id="editingId" />
          </form>
          <div class="foot">저장 포맷: <span class="mono">TSV (id\ttitle\tstart\tend\tname\tdept\tphone\tnote\tcreated_at)</span></div>
        </div>
      </section>

      <section class="card">
        <div class="inner">
          <h2>예약 목록</h2>
          <div class="search">
            <input type="search" id="q" placeholder="회의명/예약자/부서 검색" />
            <button id="btnSortSoon" class="btn-secondary">가까운 순 정렬</button>
            <button id="btnSortNew" class="btn-secondary">최신 등록순</button>
          </div>
          <div class="table-wrap">
            <table id="tbl">
              <thead>
                <tr>
                  <th>회의명</th>
                  <th>시작</th>
                  <th>종료</th>
                  <th>예약자</th>
                  <th>부서</th>
                  <th>연락처</th>
                  <th>상태</th>
                  <th>관리</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="foot">중복(시간 겹침) 감지 시 <span class="status bad">충돌</span> 표시됩니다.</div>
        </div>
      </section>
    </div>

    <div class="foot">파일 핸들: <span id="fileState" class="mono">미연결</span> · 저장 위치: <span class="mono">room.txt</span></div>
  </div>

  <script>
    // === Utility ===
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmt = (d) => new Date(d).toLocaleString('ko-KR', { hour12: false });
    const nowISO = () => new Date().toISOString();
    const toLocalInput = (date) => {
      const d = new Date(date);
      const pad = (n) => String(n).padStart(2, '0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    // === Data Model ===
    /** record = { id, title, start, end, name, dept, phone, note, created_at } */
    let records = [];
    let fileHandle = null; // FileSystemFileHandle

    function serialize(records) {
      const header = ['id','title','start','end','name','dept','phone','note','created_at'].join('\t');
      const rows = records.map(r => [r.id, r.title, r.start, r.end, r.name, r.dept, r.phone, (r.note||'').replace(/\n/g,'\\n'), r.created_at].join('\t'));
      return [header, ...rows].join('\n');
    }

    function parseTSV(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const header = lines[0].split('\t');
      const idx = (k) => header.indexOf(k);
      return lines.slice(1).filter(Boolean).map(line => {
        const c = line.split('\t');
        return {
          id: c[idx('id')],
          title: c[idx('title')],
          start: c[idx('start')],
          end: c[idx('end')],
          name: c[idx('name')],
          dept: c[idx('dept')],
          phone: c[idx('phone')],
          note: (c[idx('note')]||'').replace(/\\n/g,'\n'),
          created_at: c[idx('created_at')]
        };
      });
    }

    function overlaps(a, b) {
      // [start, end) overlap
      return new Date(a.start) < new Date(b.end) && new Date(b.start) < new Date(a.end);
    }

    function detectConflicts(list) {
      const ids = new Set();
      const conflicts = new Set();
      const sorted = [...list].sort((x, y) => new Date(x.start) - new Date(y.start));
      for (let i=0; i<sorted.length; i++) {
        for (let j=i+1; j<sorted.length; j++) {
          if (new Date(sorted[j].start) >= new Date(sorted[i].end)) break; // early exit
          if (overlaps(sorted[i], sorted[j])) {
            conflicts.add(sorted[i].id);
            conflicts.add(sorted[j].id);
          }
        }
      }
      return conflicts; // Set of ids
    }

    // === Rendering ===
    function render() {
      const q = $('#q').value.trim().toLowerCase();
      const tbody = $('#tbl tbody');
      tbody.innerHTML = '';
      const filtered = records.filter(r => [r.title, r.name, r.dept].some(v => (v||'').toLowerCase().includes(q)));
      const conflicts = detectConflicts(filtered);
      for (const r of filtered.sort((a,b)=> new Date(a.start)-new Date(b.start))) {
        const tr = document.createElement('tr');
        const conflict = conflicts.has(r.id);
        tr.innerHTML = `
          <td>${escapeHtml(r.title)}</td>
          <td>${fmt(r.start)}</td>
          <td>${fmt(r.end)}</td>
          <td>${escapeHtml(r.name||'')}</td>
          <td>${escapeHtml(r.dept||'')}</td>
          <td>${escapeHtml(r.phone||'')}</td>
          <td>${badge(r, conflict)}</td>
          <td>
            <button data-act="edit" data-id="${r.id}" class="btn-secondary">수정</button>
            <button data-act="del" data-id="${r.id}" class="btn-danger">삭제</button>
          </td>`;
        tbody.appendChild(tr);
      }
      updateFileState();
    }

    function badge(r, conflict) {
      const now = new Date();
      const st = new Date(r.start), en = new Date(r.end);
      if (conflict) return '<span class="status bad">충돌</span>';
      if (en < now) return '<span class="status">종료</span>';
      if (st <= now && now < en) return '<span class="status ok">진행중</span>';
      return '<span class="status warn">예정</span>';
    }

    function escapeHtml(s) {
      return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // === Actions ===
    $('#frm').addEventListener('submit', (e) => {
      e.preventDefault();
      const title = $('#title').value.trim();
      const start = $('#start').value;
      const end = $('#end').value;
      if (!title || !start || !end) return alert('회의명 / 시작 / 종료를 입력하세요.');
      if (new Date(start) >= new Date(end)) return alert('종료일시는 시작일시보다 늦어야 합니다.');
      const rec = {
        id: $('#editingId').value || crypto.randomUUID(),
        title,
        start: new Date(start).toISOString(),
        end: new Date(end).toISOString(),
        name: $('#name').value.trim(),
        dept: $('#dept').value.trim(),
        phone: $('#phone').value.trim(),
        note: $('#note').value.trim(),
        created_at: $('#editingId').value ? (records.find(r=>r.id===$('#editingId').value)?.created_at || nowISO()) : nowISO()
      };

      const idx = records.findIndex(r => r.id === rec.id);
      if (idx >= 0) records[idx] = rec; else records.push(rec);

      // 충돌 즉시 경고
      const conflicts = detectConflicts(records);
      if (conflicts.has(rec.id)) {
        alert('⚠️ 시간 겹침(충돌)이 있습니다. 목록 상단에서 확인하세요.');
      }

      $('#frm').reset();
      $('#editingId').value = '';
      render();
    });

    $('#btnClear').addEventListener('click', () => { $('#frm').reset(); $('#editingId').value = ''; });

    $('#q').addEventListener('input', render);
    $('#btnSortSoon').addEventListener('click', () => { records.sort((a,b)=> new Date(a.start)-new Date(b.start)); render(); });
    $('#btnSortNew').addEventListener('click', () => { records.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at)); render(); });

    $('#tbl').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const r = records.find(x => x.id === id);
      if (btn.dataset.act === 'edit') {
        if (!r) return;
        $('#title').value = r.title;
        $('#start').value = toLocalInput(r.start);
        $('#end').value = toLocalInput(r.end);
        $('#name').value = r.name || '';
        $('#dept').value = r.dept || '';
        $('#phone').value = r.phone || '';
        $('#note').value = r.note || '';
        $('#editingId').value = r.id;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else if (btn.dataset.act === 'del') {
        if (confirm('삭제하시겠습니까?')) {
          const idx = records.findIndex(x => x.id === id);
          if (idx >= 0) { records.splice(idx,1); render(); }
        }
      }
    });

    // === File System Access API ===
    const supportsFSA = 'showOpenFilePicker' in window && 'showSaveFilePicker' in window;

    $('#btnOpen').addEventListener('click', async () => {
      try {
        if (!supportsFSA) return alert('이 브라우저는 파일 직접 열기를 지원하지 않습니다. "가져오기(.txt)"를 사용하세요.');
        const [handle] = await window.showOpenFilePicker({
          multiple: false,
          types: [{ description: 'Text', accept: { 'text/plain': ['.txt'] } }],
          excludeAcceptAllOption: false
        });
        fileHandle = handle;
        const file = await handle.getFile();
        const text = await file.text();
        records = parseTSV(text);
        render();
      } catch (err) {
        if (err?.name !== 'AbortError') console.error(err);
      }
    });

    $('#btnSave').addEventListener('click', async () => {
      try {
        if (supportsFSA) {
          await ensureFileHandle();
          await writeFile(fileHandle, serialize(records));
          flash('room.txt 저장 완료');
        } else {
          downloadTxt('room.txt', serialize(records));
          alert('이 브라우저에서는 다운로드로 저장됩니다.');
        }
        updateFileState();
      } catch (err) {
        console.error(err);
        alert('저장에 실패했습니다.');
      }
    });

    async function ensureFileHandle() {
      if (!fileHandle) {
        fileHandle = await window.showSaveFilePicker({
          suggestedName: 'room.txt',
          types: [{ description: 'Text', accept: { 'text/plain': ['.txt'] } }]
        });
      }
    }

    async function writeFile(handle, contents) {
      const writable = await handle.createWritable();
      await writable.write(contents);
      await writable.close();
    }

    function downloadTxt(filename, contents) {
      const blob = new Blob([contents], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    $('#btnExport').addEventListener('click', () => {
      downloadTxt('room.txt', serialize(records));
    });

    $('#btnImport').addEventListener('click', async () => {
      try {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.txt,text/plain';
        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;
          const text = await file.text();
          records = parseTSV(text);
          render();
        };
        input.click();
      } catch (err) {
        console.error(err);
      }
    });

    function updateFileState() {
      $('#fileState').textContent = fileHandle ? (fileHandle.name || '연결됨') : '미연결';
    }

    function flash(msg) {
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position = 'fixed';
      el.style.bottom = '24px';
      el.style.left = '50%';
      el.style.transform = 'translateX(-50%)';
      el.style.background = '#0b2540';
      el.style.color = '#dbeafe';
      el.style.border = '1px solid #1e3a8a';
      el.style.borderRadius = '12px';
      el.style.padding = '10px 16px';
      el.style.zIndex = 9999;
      document.body.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 1800);
    }

    // 초기 렌더
    (function init() {
      // 예시: 시작/종료 기본값 = 현재 시각 및 +1시간
      const now = new Date();
      $('#start').value = toLocalInput(now);
      $('#end').value = toLocalInput(new Date(now.getTime()+60*60*1000));
      render();
    })();
  </script>
</body>
</html>
